begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  *  Licensed to the Apache Software Foundation (ASF) under one or more  *  contributor license agreements.  See the NOTICE file distributed with  *  this work for additional information regarding copyright ownership.  *  The ASF licenses this file to You under the Apache License, Version 2.0  *  (the "License"); you may not use this file except in compliance with  *  the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *  Unless required by applicable law or agreed to in writing, software  *  distributed under the License is distributed on an "AS IS" BASIS,  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  *  See the License for the specific language governing permissions and  *  limitations under the License.  *  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|resolver
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URI
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URISyntaxException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import

begin_import
import|import
name|java
operator|.
name|text
operator|.
name|ParseException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|text
operator|.
name|SimpleDateFormat
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Date
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ListIterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|IvyContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|IvyPatternHelper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|LogOptions
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|cache
operator|.
name|ArtifactOrigin
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|cache
operator|.
name|ModuleDescriptorWriter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|cache
operator|.
name|RepositoryCacheManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|Artifact
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|DefaultModuleDescriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|DependencyDescriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|ModuleDescriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|id
operator|.
name|ModuleId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|id
operator|.
name|ModuleRevisionId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|report
operator|.
name|ArtifactDownloadReport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|report
operator|.
name|DownloadReport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|report
operator|.
name|DownloadStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|report
operator|.
name|MetadataArtifactDownloadReport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|resolve
operator|.
name|DownloadOptions
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|resolve
operator|.
name|IvyNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|resolve
operator|.
name|ResolveData
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|resolve
operator|.
name|ResolvedModuleRevision
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|search
operator|.
name|ModuleEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|search
operator|.
name|OrganisationEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|search
operator|.
name|RevisionEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|conflict
operator|.
name|ConflictManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|latest
operator|.
name|ArtifactInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|namespace
operator|.
name|Namespace
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|parser
operator|.
name|ModuleDescriptorParser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|parser
operator|.
name|ModuleDescriptorParserRegistry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|parser
operator|.
name|xml
operator|.
name|XmlModuleDescriptorWriter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|repository
operator|.
name|ArtifactResourceResolver
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|repository
operator|.
name|Resource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|repository
operator|.
name|ResourceDownloader
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|repository
operator|.
name|file
operator|.
name|FileRepository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|repository
operator|.
name|file
operator|.
name|FileResource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|repository
operator|.
name|url
operator|.
name|URLRepository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|repository
operator|.
name|url
operator|.
name|URLResource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|resolver
operator|.
name|util
operator|.
name|MDResolvedResource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|resolver
operator|.
name|util
operator|.
name|ResolvedResource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|resolver
operator|.
name|util
operator|.
name|ResourceMDParser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|version
operator|.
name|VersionMatcher
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|util
operator|.
name|Checks
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|util
operator|.
name|ChecksumHelper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|util
operator|.
name|HostUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|util
operator|.
name|Message
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|util
operator|.
name|StringUtils
operator|.
name|splitToArray
import|;
end_import

begin_comment
comment|/**  *  */
end_comment

begin_class
specifier|public
specifier|abstract
class|class
name|BasicResolver
extends|extends
name|AbstractResolver
block|{
specifier|public
specifier|static
specifier|final
name|String
name|DESCRIPTOR_OPTIONAL
init|=
literal|"optional"
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|DESCRIPTOR_REQUIRED
init|=
literal|"required"
decl_stmt|;
comment|/**      * Exception thrown internally in getDependency to indicate a dependency is unresolved.      *<p>      * Due to the contract of getDependency, this exception is never thrown publicly, but rather      * converted in a message (either error or verbose) and returning null      *</p>      */
specifier|private
specifier|static
class|class
name|UnresolvedDependencyException
extends|extends
name|RuntimeException
block|{
specifier|private
specifier|static
specifier|final
name|long
name|serialVersionUID
init|=
literal|1L
decl_stmt|;
specifier|private
name|boolean
name|error
decl_stmt|;
comment|/**          * Dependency has not been resolved. This is not an error and won't log any message.          */
specifier|public
name|UnresolvedDependencyException
parameter_list|()
block|{
name|this
argument_list|(
literal|""
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
comment|/**          * Dependency has not been resolved. This is an error and will log a message.          */
specifier|public
name|UnresolvedDependencyException
parameter_list|(
name|String
name|message
parameter_list|)
block|{
name|this
argument_list|(
name|message
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
comment|/**          * Dependency has not been resolved. The boolean tells if it is an error or not, a message          * will be logged if non empty.          */
specifier|public
name|UnresolvedDependencyException
parameter_list|(
name|String
name|message
parameter_list|,
name|boolean
name|error
parameter_list|)
block|{
name|super
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|this
operator|.
name|error
operator|=
name|error
expr_stmt|;
block|}
specifier|public
name|boolean
name|isError
parameter_list|()
block|{
return|return
name|error
return|;
block|}
block|}
specifier|public
specifier|static
specifier|final
name|SimpleDateFormat
name|DATE_FORMAT
init|=
operator|new
name|SimpleDateFormat
argument_list|(
literal|"yyyyMMddHHmmss"
argument_list|)
decl_stmt|;
specifier|private
name|String
name|workspaceName
decl_stmt|;
comment|/**      * True if the files resolved are dependent of the environment from which they have been      * resolved, false otherwise. In general, relative paths are dependent of the environment, and      * absolute paths including machine reference are not.      */
specifier|private
name|boolean
name|envDependent
init|=
literal|true
decl_stmt|;
specifier|private
name|List
argument_list|<
name|String
argument_list|>
name|ivyattempts
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
specifier|private
name|Map
argument_list|<
name|Artifact
argument_list|,
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|artattempts
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
specifier|private
name|boolean
name|checkconsistency
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|allownomd
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|force
init|=
literal|false
decl_stmt|;
specifier|private
name|String
name|checksums
init|=
literal|null
decl_stmt|;
specifier|private
name|URLRepository
name|extartifactrep
init|=
operator|new
name|URLRepository
argument_list|()
decl_stmt|;
comment|// used only to download
comment|// external artifacts
specifier|public
name|BasicResolver
parameter_list|()
block|{
name|workspaceName
operator|=
name|HostUtil
operator|.
name|getLocalHostName
argument_list|()
expr_stmt|;
block|}
specifier|public
name|String
name|getWorkspaceName
parameter_list|()
block|{
return|return
name|workspaceName
return|;
block|}
specifier|public
name|void
name|setWorkspaceName
parameter_list|(
name|String
name|workspaceName
parameter_list|)
block|{
name|this
operator|.
name|workspaceName
operator|=
name|workspaceName
expr_stmt|;
block|}
specifier|public
name|boolean
name|isEnvDependent
parameter_list|()
block|{
return|return
name|envDependent
return|;
block|}
specifier|public
name|void
name|setEnvDependent
parameter_list|(
name|boolean
name|envDependent
parameter_list|)
block|{
name|this
operator|.
name|envDependent
operator|=
name|envDependent
expr_stmt|;
block|}
specifier|public
name|ResolvedModuleRevision
name|getDependency
parameter_list|(
name|DependencyDescriptor
name|dd
parameter_list|,
name|ResolveData
name|data
parameter_list|)
throws|throws
name|ParseException
block|{
name|IvyContext
name|context
init|=
name|IvyContext
operator|.
name|pushNewCopyContext
argument_list|()
decl_stmt|;
try|try
block|{
name|ResolvedModuleRevision
name|mr
init|=
name|data
operator|.
name|getCurrentResolvedModuleRevision
argument_list|()
decl_stmt|;
if|if
condition|(
name|mr
operator|!=
literal|null
operator|&&
name|shouldReturnResolvedModule
argument_list|(
name|dd
argument_list|,
name|mr
argument_list|)
condition|)
block|{
return|return
name|mr
return|;
block|}
if|if
condition|(
name|isForce
argument_list|()
condition|)
block|{
name|dd
operator|=
name|dd
operator|.
name|clone
argument_list|(
name|ModuleRevisionId
operator|.
name|newInstance
argument_list|(
name|dd
operator|.
name|getDependencyRevisionId
argument_list|()
argument_list|,
literal|"latest.integration"
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|DependencyDescriptor
name|systemDd
init|=
name|dd
decl_stmt|;
name|DependencyDescriptor
name|nsDd
init|=
name|fromSystem
argument_list|(
name|dd
argument_list|)
decl_stmt|;
name|context
operator|.
name|setDependencyDescriptor
argument_list|(
name|systemDd
argument_list|)
expr_stmt|;
name|context
operator|.
name|setResolveData
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|clearIvyAttempts
argument_list|()
expr_stmt|;
name|clearArtifactAttempts
argument_list|()
expr_stmt|;
name|ModuleRevisionId
name|systemMrid
init|=
name|systemDd
operator|.
name|getDependencyRevisionId
argument_list|()
decl_stmt|;
name|ModuleRevisionId
name|nsMrid
init|=
name|nsDd
operator|.
name|getDependencyRevisionId
argument_list|()
decl_stmt|;
name|checkRevision
argument_list|(
name|systemMrid
argument_list|)
expr_stmt|;
name|boolean
name|isDynamic
init|=
name|getAndCheckIsDynamic
argument_list|(
name|systemMrid
argument_list|)
decl_stmt|;
comment|// we first search for the dependency in cache
name|ResolvedModuleRevision
name|rmr
init|=
name|findModuleInCache
argument_list|(
name|systemDd
argument_list|,
name|data
argument_list|)
decl_stmt|;
if|if
condition|(
name|rmr
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|rmr
operator|.
name|getDescriptor
argument_list|()
operator|.
name|isDefault
argument_list|()
operator|&&
name|rmr
operator|.
name|getResolver
argument_list|()
operator|!=
name|this
condition|)
block|{
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": found revision in cache: "
operator|+
name|systemMrid
operator|+
literal|" (resolved by "
operator|+
name|rmr
operator|.
name|getResolver
argument_list|()
operator|.
name|getName
argument_list|()
operator|+
literal|"): but it's a default one, maybe we can find a better one"
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|isForce
argument_list|()
operator|&&
name|rmr
operator|.
name|getResolver
argument_list|()
operator|!=
name|this
condition|)
block|{
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": found revision in cache: "
operator|+
name|systemMrid
operator|+
literal|" (resolved by "
operator|+
name|rmr
operator|.
name|getResolver
argument_list|()
operator|.
name|getName
argument_list|()
operator|+
literal|"): but we are in force mode, let's try to find one ourselves"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": revision in cache: "
operator|+
name|systemMrid
argument_list|)
expr_stmt|;
return|return
name|checkLatest
argument_list|(
name|systemDd
argument_list|,
name|checkForcedResolvedModuleRevision
argument_list|(
name|rmr
argument_list|)
argument_list|,
name|data
argument_list|)
return|;
block|}
block|}
if|if
condition|(
name|data
operator|.
name|getOptions
argument_list|()
operator|.
name|isUseCacheOnly
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|UnresolvedDependencyException
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|" (useCacheOnly) : no ivy file found for "
operator|+
name|systemMrid
argument_list|,
literal|false
argument_list|)
throw|;
block|}
name|checkInterrupted
argument_list|()
expr_stmt|;
name|ResolvedResource
name|ivyRef
init|=
name|findIvyFileRef
argument_list|(
name|nsDd
argument_list|,
name|data
argument_list|)
decl_stmt|;
name|checkInterrupted
argument_list|()
expr_stmt|;
comment|// get module descriptor
name|ModuleDescriptor
name|nsMd
decl_stmt|;
name|ModuleDescriptor
name|systemMd
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|ivyRef
operator|==
literal|null
condition|)
block|{
if|if
condition|(
operator|!
name|isAllownomd
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|UnresolvedDependencyException
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": no ivy file found for "
operator|+
name|systemMrid
argument_list|,
literal|false
argument_list|)
throw|;
block|}
name|nsMd
operator|=
name|DefaultModuleDescriptor
operator|.
name|newDefaultInstance
argument_list|(
name|nsMrid
argument_list|,
name|nsDd
operator|.
name|getAllDependencyArtifacts
argument_list|()
argument_list|)
expr_stmt|;
name|ResolvedResource
name|artifactRef
init|=
name|findFirstArtifactRef
argument_list|(
name|nsMd
argument_list|,
name|nsDd
argument_list|,
name|data
argument_list|)
decl_stmt|;
name|checkInterrupted
argument_list|()
expr_stmt|;
if|if
condition|(
name|artifactRef
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|UnresolvedDependencyException
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": no ivy file nor artifact found for "
operator|+
name|systemMrid
argument_list|,
literal|false
argument_list|)
throw|;
block|}
name|long
name|lastModified
init|=
name|artifactRef
operator|.
name|getLastModified
argument_list|()
decl_stmt|;
if|if
condition|(
name|lastModified
operator|!=
literal|0
operator|&&
name|nsMd
operator|instanceof
name|DefaultModuleDescriptor
condition|)
block|{
operator|(
operator|(
name|DefaultModuleDescriptor
operator|)
name|nsMd
operator|)
operator|.
name|setLastModified
argument_list|(
name|lastModified
argument_list|)
expr_stmt|;
block|}
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": no ivy file found for "
operator|+
name|systemMrid
operator|+
literal|": using default data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|isDynamic
condition|)
block|{
name|nsMd
operator|.
name|setResolvedModuleRevisionId
argument_list|(
name|ModuleRevisionId
operator|.
name|newInstance
argument_list|(
name|nsMrid
argument_list|,
name|artifactRef
operator|.
name|getRevision
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|systemMd
operator|=
name|toSystem
argument_list|(
name|nsMd
argument_list|)
expr_stmt|;
name|MetadataArtifactDownloadReport
name|madr
init|=
operator|new
name|MetadataArtifactDownloadReport
argument_list|(
name|systemMd
operator|.
name|getMetadataArtifact
argument_list|()
argument_list|)
decl_stmt|;
name|madr
operator|.
name|setDownloadStatus
argument_list|(
name|DownloadStatus
operator|.
name|NO
argument_list|)
expr_stmt|;
name|madr
operator|.
name|setSearched
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|rmr
operator|=
operator|new
name|ResolvedModuleRevision
argument_list|(
name|this
argument_list|,
name|this
argument_list|,
name|systemMd
argument_list|,
name|madr
argument_list|,
name|isForce
argument_list|()
argument_list|)
expr_stmt|;
name|getRepositoryCacheManager
argument_list|()
operator|.
name|cacheModuleDescriptor
argument_list|(
name|this
argument_list|,
name|artifactRef
argument_list|,
name|toSystem
argument_list|(
name|dd
argument_list|)
argument_list|,
name|systemMd
operator|.
name|getAllArtifacts
argument_list|()
index|[
literal|0
index|]
argument_list|,
literal|null
argument_list|,
name|getCacheOptions
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ivyRef
operator|instanceof
name|MDResolvedResource
condition|)
block|{
name|rmr
operator|=
operator|(
operator|(
name|MDResolvedResource
operator|)
name|ivyRef
operator|)
operator|.
name|getResolvedModuleRevision
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|rmr
operator|==
literal|null
condition|)
block|{
name|rmr
operator|=
name|parse
argument_list|(
name|ivyRef
argument_list|,
name|systemDd
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rmr
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|UnresolvedDependencyException
argument_list|()
throw|;
block|}
block|}
if|if
condition|(
operator|!
name|rmr
operator|.
name|getReport
argument_list|()
operator|.
name|isDownloaded
argument_list|()
operator|&&
name|rmr
operator|.
name|getReport
argument_list|()
operator|.
name|getLocalFile
argument_list|()
operator|!=
literal|null
condition|)
block|{
return|return
name|checkLatest
argument_list|(
name|systemDd
argument_list|,
name|checkForcedResolvedModuleRevision
argument_list|(
name|rmr
argument_list|)
argument_list|,
name|data
argument_list|)
return|;
block|}
name|nsMd
operator|=
name|rmr
operator|.
name|getDescriptor
argument_list|()
expr_stmt|;
comment|// check descriptor data is in sync with resource revision and names
name|systemMd
operator|=
name|toSystem
argument_list|(
name|nsMd
argument_list|)
expr_stmt|;
if|if
condition|(
name|isCheckconsistency
argument_list|()
condition|)
block|{
name|checkDescriptorConsistency
argument_list|(
name|systemMrid
argument_list|,
name|systemMd
argument_list|,
name|ivyRef
argument_list|)
expr_stmt|;
name|checkDescriptorConsistency
argument_list|(
name|nsMrid
argument_list|,
name|nsMd
argument_list|,
name|ivyRef
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|systemMd
operator|instanceof
name|DefaultModuleDescriptor
condition|)
block|{
name|DefaultModuleDescriptor
name|defaultMd
init|=
operator|(
name|DefaultModuleDescriptor
operator|)
name|systemMd
decl_stmt|;
name|ModuleRevisionId
name|revision
init|=
name|getRevision
argument_list|(
name|ivyRef
argument_list|,
name|systemMrid
argument_list|,
name|systemMd
argument_list|)
decl_stmt|;
name|defaultMd
operator|.
name|setModuleRevisionId
argument_list|(
name|revision
argument_list|)
expr_stmt|;
name|defaultMd
operator|.
name|setResolvedModuleRevisionId
argument_list|(
name|revision
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"consistency disabled with instance of non DefaultModuleDescriptor... module info can't be updated, so consistency check will be done"
argument_list|)
expr_stmt|;
name|checkDescriptorConsistency
argument_list|(
name|nsMrid
argument_list|,
name|nsMd
argument_list|,
name|ivyRef
argument_list|)
expr_stmt|;
name|checkDescriptorConsistency
argument_list|(
name|systemMrid
argument_list|,
name|systemMd
argument_list|,
name|ivyRef
argument_list|)
expr_stmt|;
block|}
block|}
name|rmr
operator|=
operator|new
name|ResolvedModuleRevision
argument_list|(
name|this
argument_list|,
name|this
argument_list|,
name|systemMd
argument_list|,
name|toSystem
argument_list|(
name|rmr
operator|.
name|getReport
argument_list|()
argument_list|)
argument_list|,
name|isForce
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|resolveAndCheckRevision
argument_list|(
name|systemMd
argument_list|,
name|systemMrid
argument_list|,
name|ivyRef
argument_list|,
name|isDynamic
argument_list|)
expr_stmt|;
name|resolveAndCheckPublicationDate
argument_list|(
name|systemDd
argument_list|,
name|systemMd
argument_list|,
name|systemMrid
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|checkNotConvertedExclusionRule
argument_list|(
name|systemMd
argument_list|,
name|ivyRef
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ivyRef
operator|==
literal|null
operator|||
name|ivyRef
operator|.
name|getResource
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|cacheModuleDescriptor
argument_list|(
name|systemMd
argument_list|,
name|systemMrid
argument_list|,
name|ivyRef
argument_list|,
name|rmr
argument_list|)
expr_stmt|;
block|}
return|return
name|checkLatest
argument_list|(
name|systemDd
argument_list|,
name|checkForcedResolvedModuleRevision
argument_list|(
name|rmr
argument_list|)
argument_list|,
name|data
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|UnresolvedDependencyException
name|ex
parameter_list|)
block|{
if|if
condition|(
name|ex
operator|.
name|getMessage
argument_list|()
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|ex
operator|.
name|isError
argument_list|()
condition|)
block|{
name|Message
operator|.
name|error
argument_list|(
name|ex
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|verbose
argument_list|(
name|ex
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|data
operator|.
name|getCurrentResolvedModuleRevision
argument_list|()
return|;
block|}
finally|finally
block|{
name|IvyContext
operator|.
name|popContext
argument_list|()
expr_stmt|;
block|}
block|}
specifier|protected
name|boolean
name|shouldReturnResolvedModule
parameter_list|(
name|DependencyDescriptor
name|dd
parameter_list|,
name|ResolvedModuleRevision
name|mr
parameter_list|)
block|{
comment|// a resolved module revision has already been found by a prior dependency resolver
comment|// let's see if it should be returned and bypass this resolver
name|ModuleRevisionId
name|mrid
init|=
name|dd
operator|.
name|getDependencyRevisionId
argument_list|()
decl_stmt|;
name|boolean
name|isDynamic
init|=
name|getSettings
argument_list|()
operator|.
name|getVersionMatcher
argument_list|()
operator|.
name|isDynamic
argument_list|(
name|mrid
argument_list|)
decl_stmt|;
name|boolean
name|shouldReturn
init|=
name|mr
operator|.
name|isForce
argument_list|()
decl_stmt|;
name|shouldReturn
operator||=
operator|!
name|isDynamic
operator|&&
operator|!
name|mr
operator|.
name|getDescriptor
argument_list|()
operator|.
name|isDefault
argument_list|()
expr_stmt|;
name|shouldReturn
operator|&=
operator|!
name|isForce
argument_list|()
expr_stmt|;
return|return
name|shouldReturn
return|;
block|}
specifier|private
name|ResolvedModuleRevision
name|checkForcedResolvedModuleRevision
parameter_list|(
name|ResolvedModuleRevision
name|rmr
parameter_list|)
block|{
if|if
condition|(
name|rmr
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
if|if
condition|(
operator|!
name|isForce
argument_list|()
operator|||
name|rmr
operator|.
name|isForce
argument_list|()
condition|)
block|{
return|return
name|rmr
return|;
block|}
return|return
operator|new
name|ResolvedModuleRevision
argument_list|(
name|rmr
operator|.
name|getResolver
argument_list|()
argument_list|,
name|rmr
operator|.
name|getArtifactResolver
argument_list|()
argument_list|,
name|rmr
operator|.
name|getDescriptor
argument_list|()
argument_list|,
name|rmr
operator|.
name|getReport
argument_list|()
argument_list|,
literal|true
argument_list|)
return|;
block|}
specifier|private
name|void
name|cacheModuleDescriptor
parameter_list|(
name|ModuleDescriptor
name|systemMd
parameter_list|,
name|ModuleRevisionId
name|systemMrid
parameter_list|,
name|ResolvedResource
name|ivyRef
parameter_list|,
name|ResolvedModuleRevision
name|rmr
parameter_list|)
block|{
name|RepositoryCacheManager
name|cacheManager
init|=
name|getRepositoryCacheManager
argument_list|()
decl_stmt|;
specifier|final
name|ModuleDescriptorParser
name|parser
init|=
name|systemMd
operator|.
name|getParser
argument_list|()
decl_stmt|;
comment|// the metadata artifact which was used to cache the original metadata file
name|Artifact
name|requestedMetadataArtifact
init|=
operator|(
name|ivyRef
operator|==
literal|null
operator|)
condition|?
name|systemMd
operator|.
name|getMetadataArtifact
argument_list|()
else|:
name|parser
operator|.
name|getMetadataArtifact
argument_list|(
name|ModuleRevisionId
operator|.
name|newInstance
argument_list|(
name|systemMrid
argument_list|,
name|systemMd
operator|.
name|getRevision
argument_list|()
argument_list|)
argument_list|,
name|ivyRef
operator|.
name|getResource
argument_list|()
argument_list|)
decl_stmt|;
name|cacheManager
operator|.
name|originalToCachedModuleDescriptor
argument_list|(
name|this
argument_list|,
name|ivyRef
argument_list|,
name|requestedMetadataArtifact
argument_list|,
name|rmr
argument_list|,
operator|new
name|ModuleDescriptorWriter
argument_list|()
block|{
specifier|public
name|void
name|write
parameter_list|(
name|ResolvedResource
name|originalMdResource
parameter_list|,
name|ModuleDescriptor
name|md
parameter_list|,
name|File
name|src
parameter_list|,
name|File
name|dest
parameter_list|)
throws|throws
name|IOException
throws|,
name|ParseException
block|{
if|if
condition|(
name|originalMdResource
operator|==
literal|null
condition|)
block|{
comment|// a basic ivy file is written containing default data
name|XmlModuleDescriptorWriter
operator|.
name|write
argument_list|(
name|md
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// copy and update ivy file from source to cache
name|parser
operator|.
name|toIvyFile
argument_list|(
operator|new
name|FileInputStream
argument_list|(
name|src
argument_list|)
argument_list|,
name|originalMdResource
operator|.
name|getResource
argument_list|()
argument_list|,
name|dest
argument_list|,
name|md
argument_list|)
expr_stmt|;
name|long
name|repLastModified
init|=
name|originalMdResource
operator|.
name|getLastModified
argument_list|()
decl_stmt|;
if|if
condition|(
name|repLastModified
operator|>
literal|0
condition|)
block|{
name|dest
operator|.
name|setLastModified
argument_list|(
name|repLastModified
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|checkNotConvertedExclusionRule
parameter_list|(
name|ModuleDescriptor
name|systemMd
parameter_list|,
name|ResolvedResource
name|ivyRef
parameter_list|,
name|ResolveData
name|data
parameter_list|)
block|{
if|if
condition|(
operator|!
name|getNamespace
argument_list|()
operator|.
name|equals
argument_list|(
name|Namespace
operator|.
name|SYSTEM_NAMESPACE
argument_list|)
operator|&&
operator|!
name|systemMd
operator|.
name|isDefault
argument_list|()
operator|&&
name|data
operator|.
name|getSettings
argument_list|()
operator|.
name|logNotConvertedExclusionRule
argument_list|()
operator|&&
name|systemMd
operator|instanceof
name|DefaultModuleDescriptor
condition|)
block|{
name|DefaultModuleDescriptor
name|dmd
init|=
operator|(
name|DefaultModuleDescriptor
operator|)
name|systemMd
decl_stmt|;
if|if
condition|(
name|dmd
operator|.
name|isNamespaceUseful
argument_list|()
condition|)
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"the module descriptor "
operator|+
name|ivyRef
operator|.
name|getResource
argument_list|()
operator|+
literal|" has information which can't be converted into the system namespace. It will require the availability of the namespace '"
operator|+
name|getNamespace
argument_list|()
operator|.
name|getName
argument_list|()
operator|+
literal|"' to be fully usable."
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
name|void
name|resolveAndCheckPublicationDate
parameter_list|(
name|DependencyDescriptor
name|systemDd
parameter_list|,
name|ModuleDescriptor
name|systemMd
parameter_list|,
name|ModuleRevisionId
name|systemMrid
parameter_list|,
name|ResolveData
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|.
name|getDate
argument_list|()
operator|==
literal|null
condition|)
block|{
return|return;
block|}
comment|// resolve and check publication date
name|long
name|pubDate
init|=
name|getPublicationDate
argument_list|(
name|systemMd
argument_list|,
name|systemDd
argument_list|,
name|data
argument_list|)
decl_stmt|;
if|if
condition|(
name|pubDate
operator|>
name|data
operator|.
name|getDate
argument_list|()
operator|.
name|getTime
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|UnresolvedDependencyException
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": unacceptable publication date => was="
operator|+
operator|new
name|Date
argument_list|(
name|pubDate
argument_list|)
operator|+
literal|" required="
operator|+
name|data
operator|.
name|getDate
argument_list|()
argument_list|)
throw|;
block|}
if|if
condition|(
name|pubDate
operator|==
operator|-
literal|1
condition|)
block|{
throw|throw
operator|new
name|UnresolvedDependencyException
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": impossible to guess publication date: artifact missing for "
operator|+
name|systemMrid
argument_list|)
throw|;
block|}
name|systemMd
operator|.
name|setResolvedPublicationDate
argument_list|(
operator|new
name|Date
argument_list|(
name|pubDate
argument_list|)
argument_list|)
expr_stmt|;
block|}
specifier|protected
name|void
name|checkModuleDescriptorRevision
parameter_list|(
name|ModuleDescriptor
name|systemMd
parameter_list|,
name|ModuleRevisionId
name|systemMrid
parameter_list|)
block|{
if|if
condition|(
operator|!
name|getSettings
argument_list|()
operator|.
name|getVersionMatcher
argument_list|()
operator|.
name|accept
argument_list|(
name|systemMrid
argument_list|,
name|systemMd
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|UnresolvedDependencyException
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": unacceptable revision => was="
operator|+
name|systemMd
operator|.
name|getResolvedModuleRevisionId
argument_list|()
operator|.
name|getRevision
argument_list|()
operator|+
literal|" required="
operator|+
name|systemMrid
operator|.
name|getRevision
argument_list|()
argument_list|)
throw|;
block|}
block|}
specifier|private
name|boolean
name|getAndCheckIsDynamic
parameter_list|(
name|ModuleRevisionId
name|systemMrid
parameter_list|)
block|{
name|boolean
name|isDynamic
init|=
name|getSettings
argument_list|()
operator|.
name|getVersionMatcher
argument_list|()
operator|.
name|isDynamic
argument_list|(
name|systemMrid
argument_list|)
decl_stmt|;
if|if
condition|(
name|isDynamic
operator|&&
operator|!
name|acceptLatest
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|UnresolvedDependencyException
argument_list|(
literal|"dynamic revisions not handled by "
operator|+
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
operator|+
literal|". impossible to resolve "
operator|+
name|systemMrid
argument_list|)
throw|;
block|}
return|return
name|isDynamic
return|;
block|}
specifier|private
name|void
name|checkRevision
parameter_list|(
name|ModuleRevisionId
name|systemMrid
parameter_list|)
block|{
comment|// check revision
name|int
name|index
init|=
name|systemMrid
operator|.
name|getRevision
argument_list|()
operator|.
name|indexOf
argument_list|(
literal|'@'
argument_list|)
decl_stmt|;
if|if
condition|(
name|index
operator|!=
operator|-
literal|1
operator|&&
operator|!
name|systemMrid
operator|.
name|getRevision
argument_list|()
operator|.
name|substring
argument_list|(
name|index
operator|+
literal|1
argument_list|)
operator|.
name|equals
argument_list|(
name|workspaceName
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|UnresolvedDependencyException
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": unhandled revision => "
operator|+
name|systemMrid
operator|.
name|getRevision
argument_list|()
argument_list|)
throw|;
block|}
block|}
specifier|private
name|void
name|resolveAndCheckRevision
parameter_list|(
name|ModuleDescriptor
name|systemMd
parameter_list|,
name|ModuleRevisionId
name|dependencyConstraint
parameter_list|,
name|ResolvedResource
name|ivyRef
parameter_list|,
name|boolean
name|isDynamic
parameter_list|)
block|{
comment|// we get the resolved module revision id from the descriptor: it may contain extra
comment|// attributes that were not included in the dependency constraint
name|ModuleRevisionId
name|resolvedMrid
init|=
name|systemMd
operator|.
name|getResolvedModuleRevisionId
argument_list|()
decl_stmt|;
if|if
condition|(
name|resolvedMrid
operator|.
name|getRevision
argument_list|()
operator|==
literal|null
operator|||
name|resolvedMrid
operator|.
name|getRevision
argument_list|()
operator|.
name|length
argument_list|()
operator|==
literal|0
operator|||
name|resolvedMrid
operator|.
name|getRevision
argument_list|()
operator|.
name|startsWith
argument_list|(
literal|"working@"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|isDynamic
condition|)
block|{
name|resolvedMrid
operator|=
name|ModuleRevisionId
operator|.
name|newInstance
argument_list|(
name|resolvedMrid
argument_list|,
name|dependencyConstraint
operator|.
name|getRevision
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|ivyRef
operator|==
literal|null
condition|)
block|{
name|resolvedMrid
operator|=
name|systemMd
operator|.
name|getMetadataArtifact
argument_list|()
operator|.
name|getModuleRevisionId
argument_list|()
expr_stmt|;
block|}
if|else if
condition|(
name|ivyRef
operator|.
name|getRevision
argument_list|()
operator|==
literal|null
operator|||
name|ivyRef
operator|.
name|getRevision
argument_list|()
operator|.
name|length
argument_list|()
operator|==
literal|0
condition|)
block|{
name|resolvedMrid
operator|=
name|ModuleRevisionId
operator|.
name|newInstance
argument_list|(
name|resolvedMrid
argument_list|,
literal|"working@"
operator|+
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|resolvedMrid
operator|=
name|ModuleRevisionId
operator|.
name|newInstance
argument_list|(
name|resolvedMrid
argument_list|,
name|ivyRef
operator|.
name|getRevision
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|isDynamic
condition|)
block|{
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t\t["
operator|+
name|toSystem
argument_list|(
name|resolvedMrid
argument_list|)
operator|.
name|getRevision
argument_list|()
operator|+
literal|"] "
operator|+
name|dependencyConstraint
operator|.
name|getModuleId
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|systemMd
operator|.
name|setResolvedModuleRevisionId
argument_list|(
name|resolvedMrid
argument_list|)
expr_stmt|;
name|checkModuleDescriptorRevision
argument_list|(
name|systemMd
argument_list|,
name|dependencyConstraint
argument_list|)
expr_stmt|;
block|}
specifier|private
name|ModuleRevisionId
name|getRevision
parameter_list|(
name|ResolvedResource
name|ivyRef
parameter_list|,
name|ModuleRevisionId
name|askedMrid
parameter_list|,
name|ModuleDescriptor
name|md
parameter_list|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|allAttributes
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|allAttributes
operator|.
name|putAll
argument_list|(
name|md
operator|.
name|getQualifiedExtraAttributes
argument_list|()
argument_list|)
expr_stmt|;
name|allAttributes
operator|.
name|putAll
argument_list|(
name|askedMrid
operator|.
name|getQualifiedExtraAttributes
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|revision
init|=
name|ivyRef
operator|.
name|getRevision
argument_list|()
decl_stmt|;
if|if
condition|(
name|revision
operator|==
literal|null
condition|)
block|{
name|Message
operator|.
name|debug
argument_list|(
literal|"no revision found in reference for "
operator|+
name|askedMrid
argument_list|)
expr_stmt|;
if|if
condition|(
name|getSettings
argument_list|()
operator|.
name|getVersionMatcher
argument_list|()
operator|.
name|isDynamic
argument_list|(
name|askedMrid
argument_list|)
condition|)
block|{
if|if
condition|(
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getRevision
argument_list|()
operator|==
literal|null
condition|)
block|{
name|revision
operator|=
literal|"working@"
operator|+
name|getName
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|debug
argument_list|(
literal|"using "
operator|+
name|askedMrid
argument_list|)
expr_stmt|;
name|revision
operator|=
name|askedMrid
operator|.
name|getRevision
argument_list|()
expr_stmt|;
block|}
block|}
else|else
block|{
name|Message
operator|.
name|debug
argument_list|(
literal|"using "
operator|+
name|askedMrid
argument_list|)
expr_stmt|;
name|revision
operator|=
name|askedMrid
operator|.
name|getRevision
argument_list|()
expr_stmt|;
block|}
block|}
return|return
name|ModuleRevisionId
operator|.
name|newInstance
argument_list|(
name|askedMrid
operator|.
name|getOrganisation
argument_list|()
argument_list|,
name|askedMrid
operator|.
name|getName
argument_list|()
argument_list|,
name|askedMrid
operator|.
name|getBranch
argument_list|()
argument_list|,
name|revision
argument_list|,
name|allAttributes
argument_list|)
return|;
block|}
specifier|public
name|ResolvedModuleRevision
name|parse
parameter_list|(
specifier|final
name|ResolvedResource
name|mdRef
parameter_list|,
name|DependencyDescriptor
name|dd
parameter_list|,
name|ResolveData
name|data
parameter_list|)
throws|throws
name|ParseException
block|{
name|DependencyDescriptor
name|nsDd
init|=
name|dd
decl_stmt|;
name|dd
operator|=
name|toSystem
argument_list|(
name|nsDd
argument_list|)
expr_stmt|;
name|ModuleRevisionId
name|mrid
init|=
name|dd
operator|.
name|getDependencyRevisionId
argument_list|()
decl_stmt|;
name|ModuleDescriptorParser
name|parser
init|=
name|ModuleDescriptorParserRegistry
operator|.
name|getInstance
argument_list|()
operator|.
name|getParser
argument_list|(
name|mdRef
operator|.
name|getResource
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|parser
operator|==
literal|null
condition|)
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"no module descriptor parser available for "
operator|+
name|mdRef
operator|.
name|getResource
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": found md file for "
operator|+
name|mrid
argument_list|)
expr_stmt|;
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t\t=> "
operator|+
name|mdRef
argument_list|)
expr_stmt|;
name|Message
operator|.
name|debug
argument_list|(
literal|"\tparser = "
operator|+
name|parser
argument_list|)
expr_stmt|;
name|ModuleRevisionId
name|resolvedMrid
init|=
name|mrid
decl_stmt|;
comment|// first check if this dependency has not yet been resolved
if|if
condition|(
name|getSettings
argument_list|()
operator|.
name|getVersionMatcher
argument_list|()
operator|.
name|isDynamic
argument_list|(
name|mrid
argument_list|)
condition|)
block|{
name|resolvedMrid
operator|=
name|ModuleRevisionId
operator|.
name|newInstance
argument_list|(
name|mrid
argument_list|,
name|mdRef
operator|.
name|getRevision
argument_list|()
argument_list|)
expr_stmt|;
name|IvyNode
name|node
init|=
name|data
operator|.
name|getNode
argument_list|(
name|resolvedMrid
argument_list|)
decl_stmt|;
if|if
condition|(
name|node
operator|!=
literal|null
operator|&&
name|node
operator|.
name|getModuleRevision
argument_list|()
operator|!=
literal|null
condition|)
block|{
comment|// this revision has already be resolved : return it
if|if
condition|(
name|node
operator|.
name|getDescriptor
argument_list|()
operator|==
literal|null
operator|||
operator|!
name|node
operator|.
name|getDescriptor
argument_list|()
operator|.
name|isDefault
argument_list|()
condition|)
block|{
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": revision already resolved: "
operator|+
name|resolvedMrid
argument_list|)
expr_stmt|;
name|node
operator|.
name|getModuleRevision
argument_list|()
operator|.
name|getReport
argument_list|()
operator|.
name|setSearched
argument_list|(
literal|true
argument_list|)
expr_stmt|;
return|return
name|node
operator|.
name|getModuleRevision
argument_list|()
return|;
block|}
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": found already resolved revision: "
operator|+
name|resolvedMrid
operator|+
literal|": but it's a default one, maybe we can find a better one"
argument_list|)
expr_stmt|;
block|}
block|}
name|Artifact
name|moduleArtifact
init|=
name|parser
operator|.
name|getMetadataArtifact
argument_list|(
name|resolvedMrid
argument_list|,
name|mdRef
operator|.
name|getResource
argument_list|()
argument_list|)
decl_stmt|;
return|return
name|getRepositoryCacheManager
argument_list|()
operator|.
name|cacheModuleDescriptor
argument_list|(
name|this
argument_list|,
name|mdRef
argument_list|,
name|dd
argument_list|,
name|moduleArtifact
argument_list|,
name|downloader
argument_list|,
name|getCacheOptions
argument_list|(
name|data
argument_list|)
argument_list|)
return|;
block|}
specifier|protected
name|ResourceMDParser
name|getRMDParser
parameter_list|(
specifier|final
name|DependencyDescriptor
name|dd
parameter_list|,
specifier|final
name|ResolveData
name|data
parameter_list|)
block|{
return|return
operator|new
name|ResourceMDParser
argument_list|()
block|{
specifier|public
name|MDResolvedResource
name|parse
parameter_list|(
name|Resource
name|resource
parameter_list|,
name|String
name|rev
parameter_list|)
block|{
try|try
block|{
name|ResolvedModuleRevision
name|rmr
init|=
name|BasicResolver
operator|.
name|this
operator|.
name|parse
argument_list|(
operator|new
name|ResolvedResource
argument_list|(
name|resource
argument_list|,
name|rev
argument_list|)
argument_list|,
name|dd
argument_list|,
name|data
argument_list|)
decl_stmt|;
if|if
condition|(
name|rmr
operator|!=
literal|null
condition|)
block|{
return|return
operator|new
name|MDResolvedResource
argument_list|(
name|resource
argument_list|,
name|rev
argument_list|,
name|rmr
argument_list|)
return|;
block|}
block|}
catch|catch
parameter_list|(
name|ParseException
name|e
parameter_list|)
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"Failed to parse the file '"
operator|+
name|resource
operator|+
literal|"'"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
block|}
return|;
block|}
specifier|protected
name|ResourceMDParser
name|getDefaultRMDParser
parameter_list|(
specifier|final
name|ModuleId
name|mid
parameter_list|)
block|{
return|return
operator|new
name|ResourceMDParser
argument_list|()
block|{
specifier|public
name|MDResolvedResource
name|parse
parameter_list|(
name|Resource
name|resource
parameter_list|,
name|String
name|rev
parameter_list|)
block|{
name|DefaultModuleDescriptor
name|md
init|=
name|DefaultModuleDescriptor
operator|.
name|newDefaultInstance
argument_list|(
operator|new
name|ModuleRevisionId
argument_list|(
name|mid
argument_list|,
name|rev
argument_list|)
argument_list|)
decl_stmt|;
name|MetadataArtifactDownloadReport
name|madr
init|=
operator|new
name|MetadataArtifactDownloadReport
argument_list|(
name|md
operator|.
name|getMetadataArtifact
argument_list|()
argument_list|)
decl_stmt|;
name|madr
operator|.
name|setDownloadStatus
argument_list|(
name|DownloadStatus
operator|.
name|NO
argument_list|)
expr_stmt|;
name|madr
operator|.
name|setSearched
argument_list|(
literal|true
argument_list|)
expr_stmt|;
return|return
operator|new
name|MDResolvedResource
argument_list|(
name|resource
argument_list|,
name|rev
argument_list|,
operator|new
name|ResolvedModuleRevision
argument_list|(
name|BasicResolver
operator|.
name|this
argument_list|,
name|BasicResolver
operator|.
name|this
argument_list|,
name|md
argument_list|,
name|madr
argument_list|,
name|isForce
argument_list|()
argument_list|)
argument_list|)
return|;
block|}
block|}
return|;
block|}
comment|// private boolean isResolved(ResolveData data, ModuleRevisionId mrid) {
comment|// IvyNode node = getSystemNode(data, mrid);
comment|// return node != null&& node.getModuleRevision() != null;
comment|// }
comment|//
specifier|private
name|void
name|checkDescriptorConsistency
parameter_list|(
name|ModuleRevisionId
name|mrid
parameter_list|,
name|ModuleDescriptor
name|md
parameter_list|,
name|ResolvedResource
name|ivyRef
parameter_list|)
throws|throws
name|ParseException
block|{
name|boolean
name|ok
init|=
literal|true
decl_stmt|;
name|StringBuilder
name|errors
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|mrid
operator|.
name|getOrganisation
argument_list|()
operator|.
name|equals
argument_list|(
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getOrganisation
argument_list|()
argument_list|)
condition|)
block|{
name|Message
operator|.
name|error
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": bad organisation found in "
operator|+
name|ivyRef
operator|.
name|getResource
argument_list|()
operator|+
literal|": expected='"
operator|+
name|mrid
operator|.
name|getOrganisation
argument_list|()
operator|+
literal|"' found='"
operator|+
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getOrganisation
argument_list|()
operator|+
literal|"'"
argument_list|)
expr_stmt|;
name|errors
operator|.
name|append
argument_list|(
literal|"bad organisation: expected='"
argument_list|)
operator|.
name|append
argument_list|(
name|mrid
operator|.
name|getOrganisation
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|"' found='"
argument_list|)
operator|.
name|append
argument_list|(
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getOrganisation
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|"'; "
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|false
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|mrid
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
condition|)
block|{
name|Message
operator|.
name|error
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": bad module name found in "
operator|+
name|ivyRef
operator|.
name|getResource
argument_list|()
operator|+
literal|": expected='"
operator|+
name|mrid
operator|.
name|getName
argument_list|()
operator|+
literal|" found='"
operator|+
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getName
argument_list|()
operator|+
literal|"'"
argument_list|)
expr_stmt|;
name|errors
operator|.
name|append
argument_list|(
literal|"bad module name: expected='"
argument_list|)
operator|.
name|append
argument_list|(
name|mrid
operator|.
name|getName
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|"' found='"
argument_list|)
operator|.
name|append
argument_list|(
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|"'; "
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|false
expr_stmt|;
block|}
if|if
condition|(
name|mrid
operator|.
name|getBranch
argument_list|()
operator|!=
literal|null
operator|&&
operator|!
name|mrid
operator|.
name|getBranch
argument_list|()
operator|.
name|equals
argument_list|(
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getBranch
argument_list|()
argument_list|)
condition|)
block|{
name|Message
operator|.
name|error
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": bad branch name found in "
operator|+
name|ivyRef
operator|.
name|getResource
argument_list|()
operator|+
literal|": expected='"
operator|+
name|mrid
operator|.
name|getBranch
argument_list|()
operator|+
literal|" found='"
operator|+
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getBranch
argument_list|()
operator|+
literal|"'"
argument_list|)
expr_stmt|;
name|errors
operator|.
name|append
argument_list|(
literal|"bad branch name: expected='"
argument_list|)
operator|.
name|append
argument_list|(
name|mrid
operator|.
name|getBranch
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|"' found='"
argument_list|)
operator|.
name|append
argument_list|(
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getBranch
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|"'; "
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|false
expr_stmt|;
block|}
if|if
condition|(
name|ivyRef
operator|.
name|getRevision
argument_list|()
operator|!=
literal|null
operator|&&
operator|!
name|ivyRef
operator|.
name|getRevision
argument_list|()
operator|.
name|startsWith
argument_list|(
literal|"working@"
argument_list|)
operator|&&
operator|!
name|mrid
operator|.
name|getRevision
argument_list|()
operator|.
name|equals
argument_list|(
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getRevision
argument_list|()
argument_list|)
condition|)
block|{
name|ModuleRevisionId
name|expectedMrid
init|=
name|ModuleRevisionId
operator|.
name|newInstance
argument_list|(
name|mrid
argument_list|,
name|mrid
operator|.
name|getRevision
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|getSettings
argument_list|()
operator|.
name|getVersionMatcher
argument_list|()
operator|.
name|accept
argument_list|(
name|expectedMrid
argument_list|,
name|md
argument_list|)
condition|)
block|{
name|Message
operator|.
name|error
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": bad revision found in "
operator|+
name|ivyRef
operator|.
name|getResource
argument_list|()
operator|+
literal|": expected='"
operator|+
name|ivyRef
operator|.
name|getRevision
argument_list|()
operator|+
literal|" found='"
operator|+
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getRevision
argument_list|()
operator|+
literal|"'"
argument_list|)
expr_stmt|;
name|errors
operator|.
name|append
argument_list|(
literal|"bad revision: expected='"
argument_list|)
operator|.
name|append
argument_list|(
name|ivyRef
operator|.
name|getRevision
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|"' found='"
argument_list|)
operator|.
name|append
argument_list|(
name|md
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getRevision
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|"'; "
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|false
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|getSettings
argument_list|()
operator|.
name|getStatusManager
argument_list|()
operator|.
name|isStatus
argument_list|(
name|md
operator|.
name|getStatus
argument_list|()
argument_list|)
condition|)
block|{
name|Message
operator|.
name|error
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": bad status found in "
operator|+
name|ivyRef
operator|.
name|getResource
argument_list|()
operator|+
literal|": '"
operator|+
name|md
operator|.
name|getStatus
argument_list|()
operator|+
literal|"'"
argument_list|)
expr_stmt|;
name|errors
operator|.
name|append
argument_list|(
literal|"bad status: '"
argument_list|)
operator|.
name|append
argument_list|(
name|md
operator|.
name|getStatus
argument_list|()
argument_list|)
operator|.
name|append
argument_list|(
literal|"'; "
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|false
expr_stmt|;
block|}
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|extra
range|:
name|mrid
operator|.
name|getExtraAttributes
argument_list|()
operator|.
name|entrySet
argument_list|()
control|)
block|{
if|if
condition|(
name|extra
operator|.
name|getValue
argument_list|()
operator|!=
literal|null
operator|&&
operator|!
name|extra
operator|.
name|getValue
argument_list|()
operator|.
name|equals
argument_list|(
name|md
operator|.
name|getExtraAttribute
argument_list|(
name|extra
operator|.
name|getKey
argument_list|()
argument_list|)
argument_list|)
condition|)
block|{
name|String
name|errorMsg
init|=
literal|"bad "
operator|+
name|extra
operator|.
name|getKey
argument_list|()
operator|+
literal|" found in "
operator|+
name|ivyRef
operator|.
name|getResource
argument_list|()
operator|+
literal|": expected='"
operator|+
name|extra
operator|.
name|getValue
argument_list|()
operator|+
literal|"' found='"
operator|+
name|md
operator|.
name|getExtraAttribute
argument_list|(
name|extra
operator|.
name|getKey
argument_list|()
argument_list|)
operator|+
literal|"'"
decl_stmt|;
name|Message
operator|.
name|error
argument_list|(
literal|"\t"
operator|+
name|getName
argument_list|()
operator|+
literal|": "
operator|+
name|errorMsg
argument_list|)
expr_stmt|;
name|errors
operator|.
name|append
argument_list|(
name|errorMsg
argument_list|)
operator|.
name|append
argument_list|(
literal|";"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|false
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|ok
condition|)
block|{
throw|throw
operator|new
name|ParseException
argument_list|(
literal|"inconsistent module descriptor file found in '"
operator|+
name|ivyRef
operator|.
name|getResource
argument_list|()
operator|+
literal|"': "
operator|+
name|errors
argument_list|,
literal|0
argument_list|)
throw|;
block|}
block|}
comment|/**      * When the resolver has many choices, this function helps choosing one      *      * @param rress      *            the list of resolved resource which the resolver found to fit the requirement      * @param rmdparser      *            the parser of module descriptor      * @param mrid      *            the module being resolved      * @param date      *            the current date      * @return the selected resource      */
specifier|public
name|ResolvedResource
name|findResource
parameter_list|(
name|ResolvedResource
index|[]
name|rress
parameter_list|,
name|ResourceMDParser
name|rmdparser
parameter_list|,
name|ModuleRevisionId
name|mrid
parameter_list|,
name|Date
name|date
parameter_list|)
block|{
name|String
name|name
init|=
name|getName
argument_list|()
decl_stmt|;
name|VersionMatcher
name|versionMatcher
init|=
name|getSettings
argument_list|()
operator|.
name|getVersionMatcher
argument_list|()
decl_stmt|;
name|ResolvedResource
name|found
init|=
literal|null
decl_stmt|;
name|List
argument_list|<
name|ArtifactInfo
argument_list|>
name|sorted
init|=
name|getLatestStrategy
argument_list|()
operator|.
name|sort
argument_list|(
name|rress
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rejected
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|ModuleRevisionId
argument_list|>
name|foundBlacklisted
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|IvyContext
name|context
init|=
name|IvyContext
operator|.
name|getContext
argument_list|()
decl_stmt|;
name|ListIterator
argument_list|<
name|ArtifactInfo
argument_list|>
name|iter
init|=
name|sorted
operator|.
name|listIterator
argument_list|(
name|sorted
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
while|while
condition|(
name|iter
operator|.
name|hasPrevious
argument_list|()
condition|)
block|{
name|ResolvedResource
name|rres
init|=
operator|(
name|ResolvedResource
operator|)
name|iter
operator|.
name|previous
argument_list|()
decl_stmt|;
comment|// we start by filtering based on information already available,
comment|// even though we don't even know if the resource actually exist.
comment|// But checking for existence is most of the time more costly than checking
comment|// name, blacklisting and first level version matching
if|if
condition|(
name|filterNames
argument_list|(
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|Collections
operator|.
name|singleton
argument_list|(
name|rres
operator|.
name|getRevision
argument_list|()
argument_list|)
argument_list|)
argument_list|)
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|Message
operator|.
name|debug
argument_list|(
literal|"\t"
operator|+
name|name
operator|+
literal|": filtered by name: "
operator|+
name|rres
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ModuleRevisionId
name|foundMrid
init|=
name|ModuleRevisionId
operator|.
name|newInstance
argument_list|(
name|mrid
argument_list|,
name|rres
operator|.
name|getRevision
argument_list|()
argument_list|)
decl_stmt|;
name|ResolveData
name|data
init|=
name|context
operator|.
name|getResolveData
argument_list|()
decl_stmt|;
if|if
condition|(
name|data
operator|!=
literal|null
operator|&&
name|data
operator|.
name|getReport
argument_list|()
operator|!=
literal|null
operator|&&
name|data
operator|.
name|isBlacklisted
argument_list|(
name|data
operator|.
name|getReport
argument_list|()
operator|.
name|getConfiguration
argument_list|()
argument_list|,
name|foundMrid
argument_list|)
condition|)
block|{
name|Message
operator|.
name|debug
argument_list|(
literal|"\t"
operator|+
name|name
operator|+
literal|": blacklisted: "
operator|+
name|rres
argument_list|)
expr_stmt|;
name|rejected
operator|.
name|add
argument_list|(
name|rres
operator|.
name|getRevision
argument_list|()
operator|+
literal|" (blacklisted)"
argument_list|)
expr_stmt|;
name|foundBlacklisted
operator|.
name|add
argument_list|(
name|foundMrid
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|versionMatcher
operator|.
name|accept
argument_list|(
name|mrid
argument_list|,
name|foundMrid
argument_list|)
condition|)
block|{
name|Message
operator|.
name|debug
argument_list|(
literal|"\t"
operator|+
name|name
operator|+
literal|": rejected by version matcher: "
operator|+
name|rres
argument_list|)
expr_stmt|;
name|rejected
operator|.
name|add
argument_list|(
name|rres
operator|.
name|getRevision
argument_list|()
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|rres
operator|.
name|getResource
argument_list|()
operator|!=
literal|null
operator|&&
operator|!
name|rres
operator|.
name|getResource
argument_list|()
operator|.
name|exists
argument_list|()
condition|)
block|{
name|Message
operator|.
name|debug
argument_list|(
literal|"\t"
operator|+
name|name
operator|+
literal|": unreachable: "
operator|+
name|rres
operator|+
literal|"; res="
operator|+
name|rres
operator|.
name|getResource
argument_list|()
argument_list|)
expr_stmt|;
name|rejected
operator|.
name|add
argument_list|(
name|rres
operator|.
name|getRevision
argument_list|()
operator|+
literal|" (unreachable)"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|date
operator|!=
literal|null
operator|&&
name|rres
operator|.
name|getLastModified
argument_list|()
operator|>
name|date
operator|.
name|getTime
argument_list|()
condition|)
block|{
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t"
operator|+
name|name
operator|+
literal|": too young: "
operator|+
name|rres
argument_list|)
expr_stmt|;
name|rejected
operator|.
name|add
argument_list|(
name|rres
operator|.
name|getRevision
argument_list|()
operator|+
literal|" ("
operator|+
name|rres
operator|.
name|getLastModified
argument_list|()
operator|+
literal|")"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|versionMatcher
operator|.
name|needModuleDescriptor
argument_list|(
name|mrid
argument_list|,
name|foundMrid
argument_list|)
condition|)
block|{
name|ResolvedResource
name|r
init|=
name|rmdparser
operator|.
name|parse
argument_list|(
name|rres
operator|.
name|getResource
argument_list|()
argument_list|,
name|rres
operator|.
name|getRevision
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
operator|==
literal|null
condition|)
block|{
name|Message
operator|.
name|debug
argument_list|(
literal|"\t"
operator|+
name|name
operator|+
literal|": impossible to get module descriptor resource: "
operator|+
name|rres
argument_list|)
expr_stmt|;
name|rejected
operator|.
name|add
argument_list|(
name|rres
operator|.
name|getRevision
argument_list|()
operator|+
literal|" (no or bad MD)"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ModuleDescriptor
name|md
init|=
operator|(
operator|(
name|MDResolvedResource
operator|)
name|r
operator|)
operator|.
name|getResolvedModuleRevision
argument_list|()
operator|.
name|getDescriptor
argument_list|()
decl_stmt|;
if|if
condition|(
name|md
operator|.
name|isDefault
argument_list|()
condition|)
block|{
name|Message
operator|.
name|debug
argument_list|(
literal|"\t"
operator|+
name|name
operator|+
literal|": default md rejected by version matcher"
operator|+
literal|"requiring module descriptor: "
operator|+
name|rres
argument_list|)
expr_stmt|;
name|rejected
operator|.
name|add
argument_list|(
name|rres
operator|.
name|getRevision
argument_list|()
operator|+
literal|" (MD)"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|versionMatcher
operator|.
name|accept
argument_list|(
name|mrid
argument_list|,
name|md
argument_list|)
condition|)
block|{
name|Message
operator|.
name|debug
argument_list|(
literal|"\t"
operator|+
name|name
operator|+
literal|": md rejected by version matcher: "
operator|+
name|rres
argument_list|)
expr_stmt|;
name|rejected
operator|.
name|add
argument_list|(
name|rres
operator|.
name|getRevision
argument_list|()
operator|+
literal|" (MD)"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|found
operator|=
name|r
expr_stmt|;
block|}
else|else
block|{
name|found
operator|=
name|rres
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|!=
literal|null
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|found
operator|==
literal|null
operator|&&
operator|!
name|rejected
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|logAttempt
argument_list|(
name|rejected
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|found
operator|==
literal|null
operator|&&
operator|!
name|foundBlacklisted
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// all acceptable versions have been blacklisted, this means that an unsolvable conflict
comment|// has been found
name|DependencyDescriptor
name|dd
init|=
name|context
operator|.
name|getDependencyDescriptor
argument_list|()
decl_stmt|;
name|IvyNode
name|parentNode
init|=
name|context
operator|.
name|getResolveData
argument_list|()
operator|.
name|getNode
argument_list|(
name|dd
operator|.
name|getParentRevisionId
argument_list|()
argument_list|)
decl_stmt|;
name|ConflictManager
name|cm
init|=
name|parentNode
operator|.
name|getConflictManager
argument_list|(
name|mrid
operator|.
name|getModuleId
argument_list|()
argument_list|)
decl_stmt|;
name|cm
operator|.
name|handleAllBlacklistedRevisions
argument_list|(
name|dd
argument_list|,
name|foundBlacklisted
argument_list|)
expr_stmt|;
block|}
return|return
name|found
return|;
block|}
comment|/**      * Filters names before returning them in the findXXXNames or findTokenValues method.      *<p>      * Remember to call the super implementation when overriding this method.      *</p>      *      * @param names      *            the list to filter.      * @return the filtered list      */
specifier|protected
name|Collection
argument_list|<
name|String
argument_list|>
name|filterNames
parameter_list|(
name|Collection
argument_list|<
name|String
argument_list|>
name|names
parameter_list|)
block|{
name|getSettings
argument_list|()
operator|.
name|filterIgnore
argument_list|(
name|names
argument_list|)
expr_stmt|;
return|return
name|names
return|;
block|}
specifier|protected
name|void
name|clearIvyAttempts
parameter_list|()
block|{
name|ivyattempts
operator|.
name|clear
argument_list|()
expr_stmt|;
name|clearArtifactAttempts
argument_list|()
expr_stmt|;
block|}
specifier|protected
name|void
name|logIvyAttempt
parameter_list|(
name|String
name|attempt
parameter_list|)
block|{
name|ivyattempts
operator|.
name|add
argument_list|(
name|attempt
argument_list|)
expr_stmt|;
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t\ttried "
operator|+
name|attempt
argument_list|)
expr_stmt|;
block|}
specifier|protected
name|void
name|logArtifactAttempt
parameter_list|(
name|Artifact
name|art
parameter_list|,
name|String
name|attempt
parameter_list|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|attempts
init|=
name|artattempts
operator|.
name|get
argument_list|(
name|art
argument_list|)
decl_stmt|;
if|if
condition|(
name|attempts
operator|==
literal|null
condition|)
block|{
name|attempts
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
name|artattempts
operator|.
name|put
argument_list|(
name|art
argument_list|,
name|attempts
argument_list|)
expr_stmt|;
block|}
name|attempts
operator|.
name|add
argument_list|(
name|attempt
argument_list|)
expr_stmt|;
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t\ttried "
operator|+
name|attempt
argument_list|)
expr_stmt|;
block|}
specifier|protected
name|void
name|logAttempt
parameter_list|(
name|String
name|attempt
parameter_list|)
block|{
name|Artifact
name|currentArtifact
init|=
name|IvyContext
operator|.
name|getContext
argument_list|()
operator|.
name|get
argument_list|(
name|getName
argument_list|()
operator|+
literal|".artifact"
argument_list|)
decl_stmt|;
if|if
condition|(
name|currentArtifact
operator|==
literal|null
condition|)
block|{
name|logIvyAttempt
argument_list|(
name|attempt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|logArtifactAttempt
argument_list|(
name|currentArtifact
argument_list|,
name|attempt
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|reportFailure
parameter_list|()
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"==== "
operator|+
name|getName
argument_list|()
operator|+
literal|": tried"
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|m
range|:
name|ivyattempts
control|)
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"  "
operator|+
name|m
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|Artifact
argument_list|,
name|List
argument_list|<
name|String
argument_list|>
argument_list|>
name|entry
range|:
name|artattempts
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|attempts
init|=
name|entry
operator|.
name|getValue
argument_list|()
decl_stmt|;
if|if
condition|(
name|attempts
operator|!=
literal|null
condition|)
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"  -- artifact "
operator|+
name|entry
operator|.
name|getKey
argument_list|()
operator|+
literal|":"
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|m
range|:
name|attempts
control|)
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"  "
operator|+
name|m
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|reportFailure
parameter_list|(
name|Artifact
name|art
parameter_list|)
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"==== "
operator|+
name|getName
argument_list|()
operator|+
literal|": tried"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|attempts
init|=
name|artattempts
operator|.
name|get
argument_list|(
name|art
argument_list|)
decl_stmt|;
if|if
condition|(
name|attempts
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|String
name|m
range|:
name|attempts
control|)
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"  "
operator|+
name|m
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|protected
name|boolean
name|acceptLatest
parameter_list|()
block|{
return|return
literal|true
return|;
block|}
specifier|public
name|DownloadReport
name|download
parameter_list|(
name|Artifact
index|[]
name|artifacts
parameter_list|,
name|DownloadOptions
name|options
parameter_list|)
block|{
name|RepositoryCacheManager
name|cacheManager
init|=
name|getRepositoryCacheManager
argument_list|()
decl_stmt|;
name|clearArtifactAttempts
argument_list|()
expr_stmt|;
name|DownloadReport
name|dr
init|=
operator|new
name|DownloadReport
argument_list|()
decl_stmt|;
for|for
control|(
name|Artifact
name|artifact
range|:
name|artifacts
control|)
block|{
name|ArtifactDownloadReport
name|adr
init|=
name|cacheManager
operator|.
name|download
argument_list|(
name|artifact
argument_list|,
name|artifactResourceResolver
argument_list|,
name|downloader
argument_list|,
name|getCacheDownloadOptions
argument_list|(
name|options
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|DownloadStatus
operator|.
name|FAILED
operator|==
name|adr
operator|.
name|getDownloadStatus
argument_list|()
condition|)
block|{
if|if
condition|(
operator|!
name|ArtifactDownloadReport
operator|.
name|MISSING_ARTIFACT
operator|.
name|equals
argument_list|(
name|adr
operator|.
name|getDownloadDetails
argument_list|()
argument_list|)
condition|)
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"\t"
operator|+
name|adr
argument_list|)
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|DownloadStatus
operator|.
name|NO
operator|==
name|adr
operator|.
name|getDownloadStatus
argument_list|()
condition|)
block|{
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t"
operator|+
name|adr
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|LogOptions
operator|.
name|LOG_QUIET
operator|.
name|equals
argument_list|(
name|options
operator|.
name|getLog
argument_list|()
argument_list|)
condition|)
block|{
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t"
operator|+
name|adr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|info
argument_list|(
literal|"\t"
operator|+
name|adr
argument_list|)
expr_stmt|;
block|}
name|dr
operator|.
name|addArtifactReport
argument_list|(
name|adr
argument_list|)
expr_stmt|;
name|checkInterrupted
argument_list|()
expr_stmt|;
block|}
return|return
name|dr
return|;
block|}
specifier|protected
name|void
name|clearArtifactAttempts
parameter_list|()
block|{
name|artattempts
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|ArtifactDownloadReport
name|download
parameter_list|(
specifier|final
name|ArtifactOrigin
name|origin
parameter_list|,
name|DownloadOptions
name|options
parameter_list|)
block|{
name|Checks
operator|.
name|checkNotNull
argument_list|(
name|origin
argument_list|,
literal|"origin"
argument_list|)
expr_stmt|;
return|return
name|getRepositoryCacheManager
argument_list|()
operator|.
name|download
argument_list|(
name|origin
operator|.
name|getArtifact
argument_list|()
argument_list|,
operator|new
name|ArtifactResourceResolver
argument_list|()
block|{
specifier|public
name|ResolvedResource
name|resolve
parameter_list|(
name|Artifact
name|artifact
parameter_list|)
block|{
try|try
block|{
name|Resource
name|resource
init|=
name|getResource
argument_list|(
name|origin
operator|.
name|getLocation
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|resource
operator|!=
literal|null
condition|)
block|{
name|String
name|revision
init|=
name|origin
operator|.
name|getArtifact
argument_list|()
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getRevision
argument_list|()
decl_stmt|;
return|return
operator|new
name|ResolvedResource
argument_list|(
name|resource
argument_list|,
name|revision
argument_list|)
return|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|Message
operator|.
name|debug
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
block|}
argument_list|,
name|downloader
argument_list|,
name|getCacheDownloadOptions
argument_list|(
name|options
argument_list|)
argument_list|)
return|;
block|}
specifier|protected
specifier|abstract
name|Resource
name|getResource
parameter_list|(
name|String
name|source
parameter_list|)
throws|throws
name|IOException
function_decl|;
annotation|@
name|Override
specifier|public
name|boolean
name|exists
parameter_list|(
name|Artifact
name|artifact
parameter_list|)
block|{
name|ResolvedResource
name|artifactRef
init|=
name|getArtifactRef
argument_list|(
name|artifact
argument_list|,
literal|null
argument_list|)
decl_stmt|;
return|return
name|artifactRef
operator|!=
literal|null
operator|&&
name|artifactRef
operator|.
name|getResource
argument_list|()
operator|.
name|exists
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|ArtifactOrigin
name|locate
parameter_list|(
name|Artifact
name|artifact
parameter_list|)
block|{
name|ArtifactOrigin
name|origin
init|=
name|getRepositoryCacheManager
argument_list|()
operator|.
name|getSavedArtifactOrigin
argument_list|(
name|toSystem
argument_list|(
name|artifact
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ArtifactOrigin
operator|.
name|isUnknown
argument_list|(
name|origin
argument_list|)
condition|)
block|{
return|return
name|origin
return|;
block|}
name|ResolvedResource
name|artifactRef
init|=
name|getArtifactRef
argument_list|(
name|artifact
argument_list|,
literal|null
argument_list|)
decl_stmt|;
if|if
condition|(
name|artifactRef
operator|!=
literal|null
operator|&&
name|artifactRef
operator|.
name|getResource
argument_list|()
operator|.
name|exists
argument_list|()
condition|)
block|{
return|return
operator|new
name|ArtifactOrigin
argument_list|(
name|artifact
argument_list|,
name|artifactRef
operator|.
name|getResource
argument_list|()
operator|.
name|isLocal
argument_list|()
argument_list|,
name|artifactRef
operator|.
name|getResource
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
return|;
block|}
return|return
literal|null
return|;
block|}
specifier|protected
name|long
name|getPublicationDate
parameter_list|(
name|ModuleDescriptor
name|md
parameter_list|,
name|DependencyDescriptor
name|dd
parameter_list|,
name|ResolveData
name|data
parameter_list|)
block|{
if|if
condition|(
name|md
operator|.
name|getPublicationDate
argument_list|()
operator|!=
literal|null
condition|)
block|{
return|return
name|md
operator|.
name|getPublicationDate
argument_list|()
operator|.
name|getTime
argument_list|()
return|;
block|}
name|ResolvedResource
name|artifactRef
init|=
name|findFirstArtifactRef
argument_list|(
name|md
argument_list|,
name|dd
argument_list|,
name|data
argument_list|)
decl_stmt|;
if|if
condition|(
name|artifactRef
operator|!=
literal|null
condition|)
block|{
return|return
name|artifactRef
operator|.
name|getLastModified
argument_list|()
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
annotation|@
name|Override
specifier|public
name|String
name|toString
parameter_list|()
block|{
return|return
name|getName
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|String
index|[]
name|listTokenValues
parameter_list|(
name|String
name|token
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|otherTokenValues
parameter_list|)
block|{
name|Collection
argument_list|<
name|String
argument_list|>
name|ret
init|=
name|findNames
argument_list|(
name|otherTokenValues
argument_list|,
name|token
argument_list|)
decl_stmt|;
return|return
name|ret
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|ret
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|OrganisationEntry
index|[]
name|listOrganisations
parameter_list|()
block|{
name|Collection
argument_list|<
name|String
argument_list|>
name|names
init|=
name|findNames
argument_list|(
name|Collections
operator|.
expr|<
name|String
argument_list|,
name|String
operator|>
name|emptyMap
argument_list|()
argument_list|,
name|IvyPatternHelper
operator|.
name|ORGANISATION_KEY
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|OrganisationEntry
argument_list|>
name|ret
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|names
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|org
range|:
name|names
control|)
block|{
name|ret
operator|.
name|add
argument_list|(
operator|new
name|OrganisationEntry
argument_list|(
name|this
argument_list|,
name|org
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
operator|.
name|toArray
argument_list|(
operator|new
name|OrganisationEntry
index|[
name|names
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|ModuleEntry
index|[]
name|listModules
parameter_list|(
name|OrganisationEntry
name|org
parameter_list|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|tokenValues
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|tokenValues
operator|.
name|put
argument_list|(
name|IvyPatternHelper
operator|.
name|ORGANISATION_KEY
argument_list|,
name|org
operator|.
name|getOrganisation
argument_list|()
argument_list|)
expr_stmt|;
name|Collection
argument_list|<
name|String
argument_list|>
name|names
init|=
name|findNames
argument_list|(
name|tokenValues
argument_list|,
name|IvyPatternHelper
operator|.
name|MODULE_KEY
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|ModuleEntry
argument_list|>
name|ret
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|names
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|name
range|:
name|names
control|)
block|{
name|ret
operator|.
name|add
argument_list|(
operator|new
name|ModuleEntry
argument_list|(
name|org
argument_list|,
name|name
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
operator|.
name|toArray
argument_list|(
operator|new
name|ModuleEntry
index|[
name|names
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RevisionEntry
index|[]
name|listRevisions
parameter_list|(
name|ModuleEntry
name|mod
parameter_list|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|tokenValues
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|tokenValues
operator|.
name|put
argument_list|(
name|IvyPatternHelper
operator|.
name|ORGANISATION_KEY
argument_list|,
name|mod
operator|.
name|getOrganisation
argument_list|()
argument_list|)
expr_stmt|;
name|tokenValues
operator|.
name|put
argument_list|(
name|IvyPatternHelper
operator|.
name|MODULE_KEY
argument_list|,
name|mod
operator|.
name|getModule
argument_list|()
argument_list|)
expr_stmt|;
name|Collection
argument_list|<
name|String
argument_list|>
name|names
init|=
name|findNames
argument_list|(
name|tokenValues
argument_list|,
name|IvyPatternHelper
operator|.
name|REVISION_KEY
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|RevisionEntry
argument_list|>
name|ret
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|names
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|name
range|:
name|names
control|)
block|{
name|ret
operator|.
name|add
argument_list|(
operator|new
name|RevisionEntry
argument_list|(
name|mod
argument_list|,
name|name
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
operator|.
name|toArray
argument_list|(
operator|new
name|RevisionEntry
index|[
name|names
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
specifier|protected
specifier|abstract
name|Collection
argument_list|<
name|String
argument_list|>
name|findNames
parameter_list|(
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|tokenValues
parameter_list|,
name|String
name|token
parameter_list|)
function_decl|;
specifier|protected
name|ResolvedResource
name|findFirstArtifactRef
parameter_list|(
name|ModuleDescriptor
name|md
parameter_list|,
name|DependencyDescriptor
name|dd
parameter_list|,
name|ResolveData
name|data
parameter_list|)
block|{
for|for
control|(
name|String
name|configName
range|:
name|md
operator|.
name|getConfigurationsNames
argument_list|()
control|)
block|{
for|for
control|(
name|Artifact
name|artifact
range|:
name|md
operator|.
name|getArtifacts
argument_list|(
name|configName
argument_list|)
control|)
block|{
name|ResolvedResource
name|ret
init|=
name|getArtifactRef
argument_list|(
name|artifact
argument_list|,
name|data
operator|.
name|getDate
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|null
condition|)
block|{
return|return
name|ret
return|;
block|}
block|}
block|}
return|return
literal|null
return|;
block|}
specifier|protected
name|long
name|getAndCheck
parameter_list|(
name|Resource
name|resource
parameter_list|,
name|File
name|dest
parameter_list|)
throws|throws
name|IOException
block|{
name|long
name|size
init|=
name|get
argument_list|(
name|resource
argument_list|,
name|dest
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|checksum
range|:
name|getChecksumAlgorithms
argument_list|()
control|)
block|{
if|if
condition|(
name|check
argument_list|(
name|resource
argument_list|,
name|dest
argument_list|,
name|checksum
argument_list|)
condition|)
block|{
break|break;
block|}
block|}
return|return
name|size
return|;
block|}
comment|/**      * Checks the given resource checksum if a checksum resource exists.      *      * @param resource      *            the resource to check      * @param dest      *            the file where the resource has been downloaded      * @param algorithm      *            the checksum algorithm to use      * @return true if the checksum has been successfully checked, false if the checksum wasn't      *         available      * @throws IOException      *             if a checksum exist but do not match the downloaded file checksum      */
specifier|private
name|boolean
name|check
parameter_list|(
name|Resource
name|resource
parameter_list|,
name|File
name|dest
parameter_list|,
name|String
name|algorithm
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|ChecksumHelper
operator|.
name|isKnownAlgorithm
argument_list|(
name|algorithm
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Unknown checksum algorithm: "
operator|+
name|algorithm
argument_list|)
throw|;
block|}
name|Resource
name|csRes
init|=
name|resource
operator|.
name|clone
argument_list|(
name|resource
operator|.
name|getName
argument_list|()
operator|+
literal|"."
operator|+
name|algorithm
argument_list|)
decl_stmt|;
if|if
condition|(
name|csRes
operator|.
name|exists
argument_list|()
condition|)
block|{
name|Message
operator|.
name|debug
argument_list|(
name|algorithm
operator|+
literal|" file found for "
operator|+
name|resource
operator|+
literal|": checking..."
argument_list|)
expr_stmt|;
name|File
name|csFile
init|=
name|File
operator|.
name|createTempFile
argument_list|(
literal|"ivytmp"
argument_list|,
name|algorithm
argument_list|)
decl_stmt|;
try|try
block|{
name|get
argument_list|(
name|csRes
argument_list|,
name|csFile
argument_list|)
expr_stmt|;
try|try
block|{
name|ChecksumHelper
operator|.
name|check
argument_list|(
name|dest
argument_list|,
name|csFile
argument_list|,
name|algorithm
argument_list|)
expr_stmt|;
name|Message
operator|.
name|verbose
argument_list|(
name|algorithm
operator|+
literal|" OK for "
operator|+
name|resource
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ex
parameter_list|)
block|{
name|dest
operator|.
name|delete
argument_list|()
expr_stmt|;
throw|throw
name|ex
throw|;
block|}
block|}
finally|finally
block|{
name|csFile
operator|.
name|delete
argument_list|()
expr_stmt|;
block|}
block|}
else|else
block|{
return|return
literal|false
return|;
block|}
block|}
specifier|protected
name|ResolvedResource
name|getArtifactRef
parameter_list|(
name|Artifact
name|artifact
parameter_list|,
name|Date
name|date
parameter_list|)
block|{
name|IvyContext
operator|.
name|getContext
argument_list|()
operator|.
name|set
argument_list|(
name|getName
argument_list|()
operator|+
literal|".artifact"
argument_list|,
name|artifact
argument_list|)
expr_stmt|;
try|try
block|{
name|ResolvedResource
name|ret
init|=
name|findArtifactRef
argument_list|(
name|artifact
argument_list|,
name|date
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|==
literal|null
operator|&&
name|artifact
operator|.
name|getUrl
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|URL
name|url
init|=
name|artifact
operator|.
name|getUrl
argument_list|()
decl_stmt|;
name|Message
operator|.
name|verbose
argument_list|(
literal|"\tusing url for "
operator|+
name|artifact
operator|+
literal|": "
operator|+
name|url
argument_list|)
expr_stmt|;
name|logArtifactAttempt
argument_list|(
name|artifact
argument_list|,
name|url
operator|.
name|toExternalForm
argument_list|()
argument_list|)
expr_stmt|;
name|Resource
name|resource
decl_stmt|;
if|if
condition|(
literal|"file"
operator|.
name|equals
argument_list|(
name|url
operator|.
name|getProtocol
argument_list|()
argument_list|)
condition|)
block|{
name|File
name|f
decl_stmt|;
try|try
block|{
name|f
operator|=
operator|new
name|File
argument_list|(
operator|new
name|URI
argument_list|(
name|url
operator|.
name|toExternalForm
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|URISyntaxException
name|e
parameter_list|)
block|{
comment|// unexpected, try to get the best of it
name|f
operator|=
operator|new
name|File
argument_list|(
name|url
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|resource
operator|=
operator|new
name|FileResource
argument_list|(
operator|new
name|FileRepository
argument_list|()
argument_list|,
name|f
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|resource
operator|=
operator|new
name|URLResource
argument_list|(
name|url
argument_list|,
name|this
operator|.
name|getTimeoutConstraint
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
operator|new
name|ResolvedResource
argument_list|(
name|resource
argument_list|,
name|artifact
operator|.
name|getModuleRevisionId
argument_list|()
operator|.
name|getRevision
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
finally|finally
block|{
name|IvyContext
operator|.
name|getContext
argument_list|()
operator|.
name|set
argument_list|(
name|getName
argument_list|()
operator|+
literal|".artifact"
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|ResolvedResource
name|doFindArtifactRef
parameter_list|(
name|Artifact
name|artifact
parameter_list|,
name|Date
name|date
parameter_list|)
block|{
return|return
name|findArtifactRef
argument_list|(
name|artifact
argument_list|,
name|date
argument_list|)
return|;
block|}
specifier|protected
specifier|abstract
name|ResolvedResource
name|findArtifactRef
parameter_list|(
name|Artifact
name|artifact
parameter_list|,
name|Date
name|date
parameter_list|)
function_decl|;
specifier|protected
specifier|abstract
name|long
name|get
parameter_list|(
name|Resource
name|resource
parameter_list|,
name|File
name|dest
parameter_list|)
throws|throws
name|IOException
function_decl|;
specifier|public
name|boolean
name|isCheckconsistency
parameter_list|()
block|{
return|return
name|checkconsistency
return|;
block|}
specifier|public
name|void
name|setCheckconsistency
parameter_list|(
name|boolean
name|checkConsistency
parameter_list|)
block|{
name|checkconsistency
operator|=
name|checkConsistency
expr_stmt|;
block|}
specifier|public
name|void
name|setForce
parameter_list|(
name|boolean
name|force
parameter_list|)
block|{
name|this
operator|.
name|force
operator|=
name|force
expr_stmt|;
block|}
specifier|public
name|boolean
name|isForce
parameter_list|()
block|{
return|return
name|force
return|;
block|}
specifier|public
name|boolean
name|isAllownomd
parameter_list|()
block|{
return|return
name|allownomd
return|;
block|}
specifier|public
name|void
name|setAllownomd
parameter_list|(
name|boolean
name|b
parameter_list|)
block|{
name|Message
operator|.
name|deprecated
argument_list|(
literal|"allownomd is deprecated, please use descriptor=\""
operator|+
operator|(
name|b
condition|?
name|DESCRIPTOR_OPTIONAL
else|:
name|DESCRIPTOR_REQUIRED
operator|)
operator|+
literal|"\" instead"
argument_list|)
expr_stmt|;
name|allownomd
operator|=
name|b
expr_stmt|;
block|}
comment|/**      * Sets the module descriptor presence rule. Should be one of {@link #DESCRIPTOR_REQUIRED} or      * {@link #DESCRIPTOR_OPTIONAL}.      *      * @param descriptorRule      *            the descriptor rule to use with this resolver.      */
specifier|public
name|void
name|setDescriptor
parameter_list|(
name|String
name|descriptorRule
parameter_list|)
block|{
if|if
condition|(
name|DESCRIPTOR_REQUIRED
operator|.
name|equals
argument_list|(
name|descriptorRule
argument_list|)
condition|)
block|{
name|allownomd
operator|=
literal|false
expr_stmt|;
block|}
if|else if
condition|(
name|DESCRIPTOR_OPTIONAL
operator|.
name|equals
argument_list|(
name|descriptorRule
argument_list|)
condition|)
block|{
name|allownomd
operator|=
literal|true
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"unknown descriptor rule '"
operator|+
name|descriptorRule
operator|+
literal|"'. Allowed rules are: "
operator|+
name|Arrays
operator|.
name|asList
argument_list|(
name|DESCRIPTOR_REQUIRED
argument_list|,
name|DESCRIPTOR_OPTIONAL
argument_list|)
argument_list|)
throw|;
block|}
block|}
specifier|public
name|String
index|[]
name|getChecksumAlgorithms
parameter_list|()
block|{
name|String
name|csDef
init|=
operator|(
name|checksums
operator|==
literal|null
operator|)
condition|?
name|getSettings
argument_list|()
operator|.
name|getVariable
argument_list|(
literal|"ivy.checksums"
argument_list|)
else|:
name|checksums
decl_stmt|;
if|if
condition|(
name|csDef
operator|==
literal|null
condition|)
block|{
return|return
operator|new
name|String
index|[
literal|0
index|]
return|;
block|}
comment|// csDef is a comma separated list of checksum algorithms to use with this resolver
comment|// we parse and return it as a String[]
name|List
argument_list|<
name|String
argument_list|>
name|algos
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|cs
range|:
name|splitToArray
argument_list|(
name|csDef
argument_list|)
control|)
block|{
if|if
condition|(
operator|!
name|cs
operator|.
name|isEmpty
argument_list|()
operator|&&
operator|!
literal|"none"
operator|.
name|equals
argument_list|(
name|cs
argument_list|)
condition|)
block|{
name|algos
operator|.
name|add
argument_list|(
name|cs
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|algos
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|algos
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
specifier|public
name|void
name|setChecksums
parameter_list|(
name|String
name|checksums
parameter_list|)
block|{
name|this
operator|.
name|checksums
operator|=
name|checksums
expr_stmt|;
block|}
specifier|private
specifier|final
name|ArtifactResourceResolver
name|artifactResourceResolver
init|=
operator|new
name|ArtifactResourceResolver
argument_list|()
block|{
specifier|public
name|ResolvedResource
name|resolve
parameter_list|(
name|Artifact
name|artifact
parameter_list|)
block|{
name|artifact
operator|=
name|fromSystem
argument_list|(
name|artifact
argument_list|)
expr_stmt|;
return|return
name|getArtifactRef
argument_list|(
name|artifact
argument_list|,
literal|null
argument_list|)
return|;
block|}
block|}
decl_stmt|;
specifier|private
specifier|final
name|ResourceDownloader
name|downloader
init|=
operator|new
name|ResourceDownloader
argument_list|()
block|{
specifier|public
name|void
name|download
parameter_list|(
name|Artifact
name|artifact
parameter_list|,
name|Resource
name|resource
parameter_list|,
name|File
name|dest
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|dest
operator|.
name|exists
argument_list|()
condition|)
block|{
name|dest
operator|.
name|delete
argument_list|()
expr_stmt|;
block|}
name|File
name|part
init|=
operator|new
name|File
argument_list|(
name|dest
operator|.
name|getAbsolutePath
argument_list|()
operator|+
literal|".part"
argument_list|)
decl_stmt|;
if|if
condition|(
name|resource
operator|.
name|getName
argument_list|()
operator|.
name|equals
argument_list|(
name|String
operator|.
name|valueOf
argument_list|(
name|artifact
operator|.
name|getUrl
argument_list|()
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|part
operator|.
name|getParentFile
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|part
operator|.
name|getParentFile
argument_list|()
operator|.
name|mkdirs
argument_list|()
expr_stmt|;
block|}
name|extartifactrep
operator|.
name|get
argument_list|(
name|resource
operator|.
name|getName
argument_list|()
argument_list|,
name|part
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|getAndCheck
argument_list|(
name|resource
argument_list|,
name|part
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|part
operator|.
name|renameTo
argument_list|(
name|dest
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"impossible to move part file to definitive one: "
operator|+
name|part
operator|+
literal|" -> "
operator|+
name|dest
argument_list|)
throw|;
block|}
block|}
block|}
decl_stmt|;
block|}
end_class

end_unit

