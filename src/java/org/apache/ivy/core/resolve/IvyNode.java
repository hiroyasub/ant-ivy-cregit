begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  *  Licensed to the Apache Software Foundation (ASF) under one or more  *  contributor license agreements.  See the NOTICE file distributed with  *  this work for additional information regarding copyright ownership.  *  The ASF licenses this file to You under the Apache License, Version 2.0  *  (the "License"); you may not use this file except in compliance with  *  the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *  Unless required by applicable law or agreed to in writing, software  *  distributed under the License is distributed on an "AS IS" BASIS,  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  *  See the License for the specific language governing permissions and  *  limitations under the License.  *  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|resolve
package|;
end_package

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collection
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedHashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Stack
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Matcher
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|IvyContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|event
operator|.
name|resolve
operator|.
name|EndResolveDependencyEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|event
operator|.
name|resolve
operator|.
name|StartResolveDependencyEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|Artifact
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|DefaultArtifact
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|DependencyArtifactDescriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|DependencyDescriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|IncludeRule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|MDArtifact
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|descriptor
operator|.
name|ModuleDescriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|id
operator|.
name|ArtifactId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|id
operator|.
name|ModuleId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|module
operator|.
name|id
operator|.
name|ModuleRevisionId
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|resolve
operator|.
name|IvyNodeCallers
operator|.
name|Caller
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|resolve
operator|.
name|IvyNodeEviction
operator|.
name|EvictionData
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|core
operator|.
name|settings
operator|.
name|IvySettings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|conflict
operator|.
name|ConflictManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|matcher
operator|.
name|MatcherHelper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|plugins
operator|.
name|resolver
operator|.
name|DependencyResolver
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|util
operator|.
name|Message
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|util
operator|.
name|filter
operator|.
name|Filter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|ivy
operator|.
name|util
operator|.
name|filter
operator|.
name|FilterHelper
import|;
end_import

begin_class
specifier|public
class|class
name|IvyNode
implements|implements
name|Comparable
block|{
specifier|private
specifier|static
specifier|final
name|Pattern
name|FALLBACK_CONF_PATTERN
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"(.+)\\((.*)\\)"
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
class|class
name|NodeConf
block|{
specifier|private
name|IvyNode
name|_node
decl_stmt|;
specifier|private
name|String
name|_conf
decl_stmt|;
specifier|public
name|NodeConf
parameter_list|(
name|IvyNode
name|node
parameter_list|,
name|String
name|conf
parameter_list|)
block|{
if|if
condition|(
name|node
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"node must not null"
argument_list|)
throw|;
block|}
if|if
condition|(
name|conf
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|NullPointerException
argument_list|(
literal|"conf must not null"
argument_list|)
throw|;
block|}
name|_node
operator|=
name|node
expr_stmt|;
name|_conf
operator|=
name|conf
expr_stmt|;
block|}
specifier|public
specifier|final
name|String
name|getConf
parameter_list|()
block|{
return|return
name|_conf
return|;
block|}
specifier|public
specifier|final
name|IvyNode
name|getNode
parameter_list|()
block|{
return|return
name|_node
return|;
block|}
specifier|public
name|boolean
name|equals
parameter_list|(
name|Object
name|obj
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|obj
operator|instanceof
name|NodeConf
operator|)
condition|)
block|{
return|return
literal|false
return|;
block|}
return|return
name|getNode
argument_list|()
operator|.
name|equals
argument_list|(
operator|(
operator|(
name|NodeConf
operator|)
name|obj
operator|)
operator|.
name|getNode
argument_list|()
argument_list|)
operator|&&
name|getConf
argument_list|()
operator|.
name|equals
argument_list|(
operator|(
operator|(
name|NodeConf
operator|)
name|obj
operator|)
operator|.
name|getConf
argument_list|()
argument_list|)
return|;
block|}
specifier|public
name|int
name|hashCode
parameter_list|()
block|{
name|int
name|hash
init|=
literal|33
decl_stmt|;
name|hash
operator|+=
name|getNode
argument_list|()
operator|.
name|hashCode
argument_list|()
operator|*
literal|17
expr_stmt|;
name|hash
operator|+=
name|getConf
argument_list|()
operator|.
name|hashCode
argument_list|()
operator|*
literal|17
expr_stmt|;
return|return
name|hash
return|;
block|}
block|}
comment|////////// CONTEXT
specifier|private
name|ResolveData
name|_data
decl_stmt|;
specifier|private
name|IvySettings
name|_settings
decl_stmt|;
comment|////////// DELEGATES
specifier|private
name|IvyNodeCallers
name|_callers
decl_stmt|;
specifier|private
name|IvyNodeEviction
name|_eviction
decl_stmt|;
comment|////////// MAIN DATA
specifier|private
name|IvyNode
name|_root
decl_stmt|;
comment|// id as requested, i.e. may be with latest rev
specifier|private
name|ModuleRevisionId
name|_id
decl_stmt|;
comment|// set only when node has been built or updated from a DependencyDescriptor
comment|// Map(IvyNode parent -> DependencyDescriptor)
specifier|private
name|Map
name|_dds
init|=
operator|new
name|HashMap
argument_list|()
decl_stmt|;
comment|// Set when data has been loaded only, or when constructed from a module descriptor
specifier|private
name|ModuleDescriptor
name|_md
decl_stmt|;
specifier|private
name|ResolvedModuleRevision
name|_module
decl_stmt|;
comment|////////// LOADING METADATA
specifier|private
name|Exception
name|_problem
init|=
literal|null
decl_stmt|;
specifier|private
name|boolean
name|_downloaded
init|=
literal|false
decl_stmt|;
specifier|private
name|boolean
name|_searched
init|=
literal|false
decl_stmt|;
specifier|private
name|Collection
name|_confsToFetch
init|=
operator|new
name|HashSet
argument_list|()
decl_stmt|;
specifier|private
name|Collection
name|_fetchedConfigurations
init|=
operator|new
name|HashSet
argument_list|()
decl_stmt|;
specifier|private
name|Collection
name|_loadedRootModuleConfs
init|=
operator|new
name|HashSet
argument_list|()
decl_stmt|;
comment|////////// USAGE DATA
comment|// Map (String rootConfName -> Set(String confName))
comment|// used to know which configurations of the dependency are required
comment|// for each root module configuration
specifier|private
name|Map
name|_rootModuleConfs
init|=
operator|new
name|HashMap
argument_list|()
decl_stmt|;
comment|// Map (NodeConf in -> Set(String conf))
specifier|private
name|Map
name|_requiredConfs
init|=
operator|new
name|HashMap
argument_list|()
decl_stmt|;
comment|// Map (String rootModuleConf -> Set(DependencyArtifactDescriptor))
specifier|private
name|Map
name|_dependencyArtifacts
init|=
operator|new
name|HashMap
argument_list|()
decl_stmt|;
comment|// Map (String rootModuleConf -> Set(IncludeRule))
specifier|private
name|Map
name|_dependencyIncludes
init|=
operator|new
name|HashMap
argument_list|()
decl_stmt|;
specifier|public
name|IvyNode
parameter_list|(
name|ResolveData
name|data
parameter_list|,
name|IvyNode
name|parent
parameter_list|,
name|DependencyDescriptor
name|dd
parameter_list|)
block|{
name|_id
operator|=
name|dd
operator|.
name|getDependencyRevisionId
argument_list|()
expr_stmt|;
name|_dds
operator|.
name|put
argument_list|(
name|parent
argument_list|,
name|dd
argument_list|)
expr_stmt|;
name|_root
operator|=
name|parent
operator|.
name|getRoot
argument_list|()
expr_stmt|;
name|init
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
specifier|public
name|IvyNode
parameter_list|(
name|ResolveData
name|data
parameter_list|,
name|ModuleDescriptor
name|md
parameter_list|)
block|{
name|_id
operator|=
name|md
operator|.
name|getModuleRevisionId
argument_list|()
expr_stmt|;
name|_md
operator|=
name|md
expr_stmt|;
name|_root
operator|=
name|this
expr_stmt|;
name|init
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|init
parameter_list|(
name|ResolveData
name|data
parameter_list|)
block|{
name|_data
operator|=
name|data
expr_stmt|;
name|_settings
operator|=
name|data
operator|.
name|getSettings
argument_list|()
expr_stmt|;
name|_eviction
operator|=
operator|new
name|IvyNodeEviction
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|_callers
operator|=
operator|new
name|IvyNodeCallers
argument_list|(
name|this
argument_list|)
expr_stmt|;
block|}
comment|/**      * After the call node may be discarded. To avoid using discarded node, make sure      * to get the real node after the call      * IvyNode node = ...      * node.loadData();      * node = node.getRealNode();      * ...      */
specifier|public
name|boolean
name|loadData
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|IvyNode
name|parent
parameter_list|,
name|String
name|parentConf
parameter_list|,
name|String
name|conf
parameter_list|,
name|boolean
name|shouldBePublic
parameter_list|)
block|{
name|boolean
name|loaded
init|=
literal|false
decl_stmt|;
if|if
condition|(
operator|!
name|isEvicted
argument_list|(
name|rootModuleConf
argument_list|)
operator|&&
operator|(
name|hasConfigurationsToLoad
argument_list|()
operator|||
operator|!
name|isRootModuleConfLoaded
argument_list|(
name|rootModuleConf
argument_list|)
operator|)
operator|&&
operator|!
name|hasProblem
argument_list|()
condition|)
block|{
name|markRootModuleConfLoaded
argument_list|(
name|rootModuleConf
argument_list|)
expr_stmt|;
if|if
condition|(
name|_md
operator|==
literal|null
condition|)
block|{
name|DependencyResolver
name|resolver
init|=
name|_data
operator|.
name|getSettings
argument_list|()
operator|.
name|getResolver
argument_list|(
name|getModuleId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|resolver
operator|==
literal|null
condition|)
block|{
name|Message
operator|.
name|error
argument_list|(
literal|"no resolver found for "
operator|+
name|getModuleId
argument_list|()
operator|+
literal|": check your configuration"
argument_list|)
expr_stmt|;
name|_problem
operator|=
operator|new
name|RuntimeException
argument_list|(
literal|"no resolver found for "
operator|+
name|getModuleId
argument_list|()
operator|+
literal|": check your configuration"
argument_list|)
expr_stmt|;
name|_data
operator|.
name|getReport
argument_list|()
operator|.
name|addDependency
argument_list|(
name|this
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
try|try
block|{
name|Message
operator|.
name|debug
argument_list|(
literal|"\tusing "
operator|+
name|resolver
operator|+
literal|" to resolve "
operator|+
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|DependencyDescriptor
name|dependencyDescriptor
init|=
name|getDependencyDescriptor
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|_data
operator|.
name|getEventManager
argument_list|()
operator|.
name|fireIvyEvent
argument_list|(
operator|new
name|StartResolveDependencyEvent
argument_list|(
name|resolver
argument_list|,
name|dependencyDescriptor
argument_list|)
argument_list|)
expr_stmt|;
name|_module
operator|=
name|resolver
operator|.
name|getDependency
argument_list|(
name|dependencyDescriptor
argument_list|,
name|_data
argument_list|)
expr_stmt|;
name|_data
operator|.
name|getEventManager
argument_list|()
operator|.
name|fireIvyEvent
argument_list|(
operator|new
name|EndResolveDependencyEvent
argument_list|(
name|resolver
argument_list|,
name|dependencyDescriptor
argument_list|,
name|_module
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|_module
operator|!=
literal|null
condition|)
block|{
name|_data
operator|.
name|getCacheManager
argument_list|()
operator|.
name|saveResolver
argument_list|(
name|_module
operator|.
name|getDescriptor
argument_list|()
argument_list|,
name|_module
operator|.
name|getResolver
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
name|_data
operator|.
name|getCacheManager
argument_list|()
operator|.
name|saveArtResolver
argument_list|(
name|_module
operator|.
name|getDescriptor
argument_list|()
argument_list|,
name|_module
operator|.
name|getArtifactResolver
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|_settings
operator|.
name|logModuleWhenFound
argument_list|()
condition|)
block|{
name|Message
operator|.
name|info
argument_list|(
literal|"\tfound "
operator|+
name|_module
operator|.
name|getId
argument_list|()
operator|+
literal|" in "
operator|+
name|_module
operator|.
name|getResolver
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|verbose
argument_list|(
literal|"\tfound "
operator|+
name|_module
operator|.
name|getId
argument_list|()
operator|+
literal|" in "
operator|+
name|_module
operator|.
name|getResolver
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|_data
operator|.
name|getSettings
argument_list|()
operator|.
name|getVersionMatcher
argument_list|()
operator|.
name|isDynamic
argument_list|(
name|getId
argument_list|()
argument_list|)
condition|)
block|{
comment|// IVY-56: check if revision has actually been resolved
if|if
condition|(
name|_data
operator|.
name|getSettings
argument_list|()
operator|.
name|getVersionMatcher
argument_list|()
operator|.
name|isDynamic
argument_list|(
name|_module
operator|.
name|getId
argument_list|()
argument_list|)
condition|)
block|{
name|Message
operator|.
name|error
argument_list|(
literal|"impossible to resolve dynamic revision for "
operator|+
name|getId
argument_list|()
operator|+
literal|": check your configuration and make sure revision is part of your pattern"
argument_list|)
expr_stmt|;
name|_problem
operator|=
operator|new
name|RuntimeException
argument_list|(
literal|"impossible to resolve dynamic revision"
argument_list|)
expr_stmt|;
name|_data
operator|.
name|getReport
argument_list|()
operator|.
name|addDependency
argument_list|(
name|this
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
name|IvyNode
name|resolved
init|=
name|_data
operator|.
name|getNode
argument_list|(
name|_module
operator|.
name|getId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|resolved
operator|!=
literal|null
condition|)
block|{
comment|// exact revision has already been resolved
comment|// => update it and discard this node
name|_md
operator|=
name|_module
operator|.
name|getDescriptor
argument_list|()
expr_stmt|;
comment|// needed for handleConfiguration
if|if
condition|(
operator|!
name|handleConfiguration
argument_list|(
name|loaded
argument_list|,
name|rootModuleConf
argument_list|,
name|parent
argument_list|,
name|parentConf
argument_list|,
name|conf
argument_list|,
name|shouldBePublic
argument_list|)
condition|)
block|{
return|return
literal|false
return|;
block|}
if|if
condition|(
name|resolved
operator|.
name|_md
operator|==
literal|null
condition|)
block|{
name|resolved
operator|.
name|_md
operator|=
name|_md
expr_stmt|;
block|}
if|if
condition|(
name|resolved
operator|.
name|_module
operator|==
literal|null
condition|)
block|{
name|resolved
operator|.
name|_module
operator|=
name|_module
expr_stmt|;
block|}
name|resolved
operator|.
name|_downloaded
operator||=
name|_module
operator|.
name|isDownloaded
argument_list|()
expr_stmt|;
name|resolved
operator|.
name|_searched
operator||=
name|_module
operator|.
name|isSearched
argument_list|()
expr_stmt|;
name|resolved
operator|.
name|_dds
operator|.
name|putAll
argument_list|(
name|_dds
argument_list|)
expr_stmt|;
name|resolved
operator|.
name|updateDataFrom
argument_list|(
name|this
argument_list|,
name|rootModuleConf
argument_list|)
expr_stmt|;
name|resolved
operator|.
name|loadData
argument_list|(
name|rootModuleConf
argument_list|,
name|parent
argument_list|,
name|parentConf
argument_list|,
name|conf
argument_list|,
name|shouldBePublic
argument_list|)
expr_stmt|;
name|DependencyDescriptor
name|dd
init|=
name|dependencyDescriptor
decl_stmt|;
if|if
condition|(
name|dd
operator|!=
literal|null
condition|)
block|{
name|resolved
operator|.
name|addDependencyArtifacts
argument_list|(
name|rootModuleConf
argument_list|,
name|dd
operator|.
name|getDependencyArtifacts
argument_list|(
name|parentConf
argument_list|)
argument_list|)
expr_stmt|;
name|resolved
operator|.
name|addDependencyIncludes
argument_list|(
name|rootModuleConf
argument_list|,
name|dd
operator|.
name|getIncludeRules
argument_list|(
name|parentConf
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|_data
operator|.
name|replaceNode
argument_list|(
name|getId
argument_list|()
argument_list|,
name|resolved
argument_list|,
name|rootModuleConf
argument_list|)
expr_stmt|;
comment|// this actually discards the node
if|if
condition|(
name|_settings
operator|.
name|logResolvedRevision
argument_list|()
condition|)
block|{
name|Message
operator|.
name|info
argument_list|(
literal|"\t["
operator|+
name|_module
operator|.
name|getId
argument_list|()
operator|.
name|getRevision
argument_list|()
operator|+
literal|"] "
operator|+
name|getId
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t["
operator|+
name|_module
operator|.
name|getId
argument_list|()
operator|.
name|getRevision
argument_list|()
operator|+
literal|"] "
operator|+
name|getId
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
literal|true
return|;
block|}
block|}
name|_downloaded
operator|=
name|_module
operator|.
name|isDownloaded
argument_list|()
expr_stmt|;
name|_searched
operator|=
name|_module
operator|.
name|isSearched
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"\tmodule not found: "
operator|+
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|resolver
operator|.
name|reportFailure
argument_list|()
expr_stmt|;
name|_problem
operator|=
operator|new
name|RuntimeException
argument_list|(
literal|"not found"
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|_problem
operator|=
name|e
expr_stmt|;
block|}
comment|// still not resolved, report error
if|if
condition|(
name|_module
operator|==
literal|null
condition|)
block|{
name|_data
operator|.
name|getReport
argument_list|()
operator|.
name|addDependency
argument_list|(
name|this
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
else|else
block|{
name|loaded
operator|=
literal|true
expr_stmt|;
if|if
condition|(
name|_settings
operator|.
name|getVersionMatcher
argument_list|()
operator|.
name|isDynamic
argument_list|(
name|getId
argument_list|()
argument_list|)
condition|)
block|{
if|if
condition|(
name|_settings
operator|.
name|logResolvedRevision
argument_list|()
condition|)
block|{
name|Message
operator|.
name|info
argument_list|(
literal|"\t["
operator|+
name|_module
operator|.
name|getId
argument_list|()
operator|.
name|getRevision
argument_list|()
operator|+
literal|"] "
operator|+
name|getId
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|verbose
argument_list|(
literal|"\t["
operator|+
name|_module
operator|.
name|getId
argument_list|()
operator|.
name|getRevision
argument_list|()
operator|+
literal|"] "
operator|+
name|getId
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|_md
operator|=
name|_module
operator|.
name|getDescriptor
argument_list|()
expr_stmt|;
name|_confsToFetch
operator|.
name|remove
argument_list|(
literal|"*"
argument_list|)
expr_stmt|;
name|updateConfsToFetch
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|resolveSpecialConfigurations
argument_list|(
name|getRequiredConfigurations
argument_list|(
name|parent
argument_list|,
name|parentConf
argument_list|)
argument_list|,
name|this
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|loaded
operator|=
literal|true
expr_stmt|;
block|}
block|}
if|if
condition|(
name|hasProblem
argument_list|()
condition|)
block|{
name|_data
operator|.
name|getReport
argument_list|()
operator|.
name|addDependency
argument_list|(
name|this
argument_list|)
expr_stmt|;
return|return
name|handleConfiguration
argument_list|(
name|loaded
argument_list|,
name|rootModuleConf
argument_list|,
name|parent
argument_list|,
name|parentConf
argument_list|,
name|conf
argument_list|,
name|shouldBePublic
argument_list|)
operator|&&
name|loaded
return|;
block|}
if|if
condition|(
operator|!
name|handleConfiguration
argument_list|(
name|loaded
argument_list|,
name|rootModuleConf
argument_list|,
name|parent
argument_list|,
name|parentConf
argument_list|,
name|conf
argument_list|,
name|shouldBePublic
argument_list|)
condition|)
block|{
return|return
literal|false
return|;
block|}
name|DependencyDescriptor
name|dd
init|=
name|getDependencyDescriptor
argument_list|(
name|parent
argument_list|)
decl_stmt|;
if|if
condition|(
name|dd
operator|!=
literal|null
condition|)
block|{
name|addDependencyArtifacts
argument_list|(
name|rootModuleConf
argument_list|,
name|dd
operator|.
name|getDependencyArtifacts
argument_list|(
name|parentConf
argument_list|)
argument_list|)
expr_stmt|;
name|addDependencyIncludes
argument_list|(
name|rootModuleConf
argument_list|,
name|dd
operator|.
name|getIncludeRules
argument_list|(
name|parentConf
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|loaded
return|;
block|}
specifier|public
name|Collection
name|getDependencies
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|String
index|[]
name|confs
parameter_list|)
block|{
if|if
condition|(
name|_md
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"impossible to get dependencies when data has not been loaded"
argument_list|)
throw|;
block|}
if|if
condition|(
name|Arrays
operator|.
name|asList
argument_list|(
name|confs
argument_list|)
operator|.
name|contains
argument_list|(
literal|"*"
argument_list|)
condition|)
block|{
name|confs
operator|=
name|_md
operator|.
name|getConfigurationsNames
argument_list|()
expr_stmt|;
block|}
name|Collection
name|deps
init|=
operator|new
name|HashSet
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|confs
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|deps
operator|.
name|addAll
argument_list|(
name|getDependencies
argument_list|(
name|rootModuleConf
argument_list|,
name|confs
index|[
name|i
index|]
argument_list|,
name|confs
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|deps
return|;
block|}
specifier|public
name|Collection
name|getDependencies
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|String
name|conf
parameter_list|,
name|String
name|requestedConf
parameter_list|)
block|{
if|if
condition|(
name|_md
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"impossible to get dependencies when data has not been loaded"
argument_list|)
throw|;
block|}
name|DependencyDescriptor
index|[]
name|dds
init|=
name|_md
operator|.
name|getDependencies
argument_list|()
decl_stmt|;
name|Collection
name|dependencies
init|=
operator|new
name|LinkedHashSet
argument_list|()
decl_stmt|;
comment|// it's important to respect dependencies order
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|dds
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|DependencyDescriptor
name|dd
init|=
name|dds
index|[
name|i
index|]
decl_stmt|;
name|String
index|[]
name|dependencyConfigurations
init|=
name|dd
operator|.
name|getDependencyConfigurations
argument_list|(
name|conf
argument_list|,
name|requestedConf
argument_list|)
decl_stmt|;
if|if
condition|(
name|dependencyConfigurations
operator|.
name|length
operator|==
literal|0
condition|)
block|{
comment|// no configuration of the dependency is required for current confs :
comment|// it is exactly the same as if there was no dependency at all on it
continue|continue;
block|}
if|if
condition|(
name|isDependencyModuleExcluded
argument_list|(
name|rootModuleConf
argument_list|,
name|dd
operator|.
name|getDependencyRevisionId
argument_list|()
argument_list|,
name|conf
argument_list|)
condition|)
block|{
comment|// the whole module is excluded, it is considered as not being part of dependencies at all
name|Message
operator|.
name|verbose
argument_list|(
literal|"excluding "
operator|+
name|dd
operator|.
name|getDependencyRevisionId
argument_list|()
operator|+
literal|" in "
operator|+
name|conf
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|IvyNode
name|depNode
init|=
name|_data
operator|.
name|getNode
argument_list|(
name|dd
operator|.
name|getDependencyRevisionId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|depNode
operator|==
literal|null
condition|)
block|{
name|depNode
operator|=
operator|new
name|IvyNode
argument_list|(
name|_data
argument_list|,
name|this
argument_list|,
name|dd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|depNode
operator|.
name|addDependencyDescriptor
argument_list|(
name|this
argument_list|,
name|dd
argument_list|)
expr_stmt|;
if|if
condition|(
name|depNode
operator|.
name|hasProblem
argument_list|()
condition|)
block|{
comment|// dependency already tried to be resolved, but unsuccessfully
comment|// nothing special to do
block|}
block|}
name|Collection
name|confs
init|=
name|Arrays
operator|.
name|asList
argument_list|(
name|resolveSpecialConfigurations
argument_list|(
name|dependencyConfigurations
argument_list|,
name|depNode
argument_list|)
argument_list|)
decl_stmt|;
name|depNode
operator|.
name|updateConfsToFetch
argument_list|(
name|confs
argument_list|)
expr_stmt|;
name|depNode
operator|.
name|setRequiredConfs
argument_list|(
name|this
argument_list|,
name|conf
argument_list|,
name|confs
argument_list|)
expr_stmt|;
name|depNode
operator|.
name|addCaller
argument_list|(
name|rootModuleConf
argument_list|,
name|this
argument_list|,
name|conf
argument_list|,
name|dependencyConfigurations
argument_list|,
name|dd
argument_list|)
expr_stmt|;
name|dependencies
operator|.
name|add
argument_list|(
name|depNode
argument_list|)
expr_stmt|;
block|}
return|return
name|dependencies
return|;
block|}
specifier|private
name|void
name|addDependencyDescriptor
parameter_list|(
name|IvyNode
name|parent
parameter_list|,
name|DependencyDescriptor
name|dd
parameter_list|)
block|{
name|_dds
operator|.
name|put
argument_list|(
name|parent
argument_list|,
name|dd
argument_list|)
expr_stmt|;
block|}
specifier|public
name|DependencyDescriptor
name|getDependencyDescriptor
parameter_list|(
name|IvyNode
name|parent
parameter_list|)
block|{
return|return
operator|(
name|DependencyDescriptor
operator|)
name|_dds
operator|.
name|get
argument_list|(
name|parent
argument_list|)
return|;
block|}
specifier|private
name|boolean
name|isDependencyModuleExcluded
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|ModuleRevisionId
name|dependencyRevisionId
parameter_list|,
name|String
name|conf
parameter_list|)
block|{
return|return
name|_callers
operator|.
name|doesCallersExclude
argument_list|(
name|rootModuleConf
argument_list|,
name|DefaultArtifact
operator|.
name|newIvyArtifact
argument_list|(
name|dependencyRevisionId
argument_list|,
literal|null
argument_list|)
argument_list|)
return|;
block|}
specifier|public
name|boolean
name|hasConfigurationsToLoad
parameter_list|()
block|{
return|return
operator|!
name|_confsToFetch
operator|.
name|isEmpty
argument_list|()
return|;
block|}
specifier|private
name|boolean
name|markRootModuleConfLoaded
parameter_list|(
name|String
name|rootModuleConf
parameter_list|)
block|{
return|return
name|_loadedRootModuleConfs
operator|.
name|add
argument_list|(
name|rootModuleConf
argument_list|)
return|;
block|}
specifier|private
name|boolean
name|isRootModuleConfLoaded
parameter_list|(
name|String
name|rootModuleConf
parameter_list|)
block|{
return|return
name|_loadedRootModuleConfs
operator|.
name|contains
argument_list|(
name|rootModuleConf
argument_list|)
return|;
block|}
specifier|private
name|boolean
name|handleConfiguration
parameter_list|(
name|boolean
name|loaded
parameter_list|,
name|String
name|rootModuleConf
parameter_list|,
name|IvyNode
name|parent
parameter_list|,
name|String
name|parentConf
parameter_list|,
name|String
name|conf
parameter_list|,
name|boolean
name|shouldBePublic
parameter_list|)
block|{
if|if
condition|(
name|_md
operator|!=
literal|null
condition|)
block|{
name|String
index|[]
name|confs
init|=
name|getRealConfs
argument_list|(
name|conf
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|confs
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|Configuration
name|c
init|=
name|_md
operator|.
name|getConfiguration
argument_list|(
name|confs
index|[
name|i
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|c
operator|==
literal|null
condition|)
block|{
name|_confsToFetch
operator|.
name|remove
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conf
operator|.
name|equals
argument_list|(
name|confs
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|_problem
operator|=
operator|new
name|RuntimeException
argument_list|(
literal|"configuration(s) not found in "
operator|+
name|this
operator|+
literal|": "
operator|+
name|conf
operator|+
literal|". Missing configuration: "
operator|+
name|confs
index|[
name|i
index|]
operator|+
literal|". It was required from "
operator|+
name|parent
operator|+
literal|" "
operator|+
name|parentConf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|_problem
operator|=
operator|new
name|RuntimeException
argument_list|(
literal|"configuration(s) not found in "
operator|+
name|this
operator|+
literal|": "
operator|+
name|confs
index|[
name|i
index|]
operator|+
literal|". It was required from "
operator|+
name|parent
operator|+
literal|" "
operator|+
name|parentConf
argument_list|)
expr_stmt|;
block|}
name|_data
operator|.
name|getReport
argument_list|()
operator|.
name|addDependency
argument_list|(
name|this
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
if|else if
condition|(
name|shouldBePublic
operator|&&
operator|!
name|isRoot
argument_list|()
operator|&&
name|c
operator|.
name|getVisibility
argument_list|()
operator|!=
name|Configuration
operator|.
name|Visibility
operator|.
name|PUBLIC
condition|)
block|{
name|_confsToFetch
operator|.
name|remove
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|_problem
operator|=
operator|new
name|RuntimeException
argument_list|(
literal|"configuration not public in "
operator|+
name|this
operator|+
literal|": "
operator|+
name|c
operator|+
literal|". It was required from "
operator|+
name|parent
operator|+
literal|" "
operator|+
name|parentConf
argument_list|)
expr_stmt|;
name|_data
operator|.
name|getReport
argument_list|()
operator|.
name|addDependency
argument_list|(
name|this
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
if|if
condition|(
name|loaded
condition|)
block|{
name|_fetchedConfigurations
operator|.
name|add
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|_confsToFetch
operator|.
name|removeAll
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|confs
argument_list|)
argument_list|)
expr_stmt|;
name|_confsToFetch
operator|.
name|remove
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
name|addRootModuleConfigurations
argument_list|(
name|rootModuleConf
argument_list|,
name|confs
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|true
return|;
block|}
specifier|private
name|String
name|getDefaultConf
parameter_list|(
name|String
name|conf
parameter_list|)
block|{
name|Matcher
name|m
init|=
name|FALLBACK_CONF_PATTERN
operator|.
name|matcher
argument_list|(
name|conf
argument_list|)
decl_stmt|;
if|if
condition|(
name|m
operator|.
name|matches
argument_list|()
condition|)
block|{
return|return
name|m
operator|.
name|group
argument_list|(
literal|2
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|conf
return|;
block|}
block|}
specifier|private
name|String
name|getMainConf
parameter_list|(
name|String
name|conf
parameter_list|)
block|{
name|Matcher
name|m
init|=
name|FALLBACK_CONF_PATTERN
operator|.
name|matcher
argument_list|(
name|conf
argument_list|)
decl_stmt|;
if|if
condition|(
name|m
operator|.
name|matches
argument_list|()
condition|)
block|{
return|return
name|m
operator|.
name|group
argument_list|(
literal|1
argument_list|)
return|;
block|}
else|else
block|{
return|return
literal|null
return|;
block|}
block|}
specifier|public
name|void
name|updateConfsToFetch
parameter_list|(
name|Collection
name|confs
parameter_list|)
block|{
name|_confsToFetch
operator|.
name|addAll
argument_list|(
name|confs
argument_list|)
expr_stmt|;
name|_confsToFetch
operator|.
name|removeAll
argument_list|(
name|_fetchedConfigurations
argument_list|)
expr_stmt|;
block|}
comment|/**      * resolve the '*' special configurations if necessary and possible      */
specifier|private
name|String
index|[]
name|resolveSpecialConfigurations
parameter_list|(
name|String
index|[]
name|dependencyConfigurations
parameter_list|,
name|IvyNode
name|node
parameter_list|)
block|{
if|if
condition|(
name|dependencyConfigurations
operator|.
name|length
operator|==
literal|1
operator|&&
name|dependencyConfigurations
index|[
literal|0
index|]
operator|.
name|startsWith
argument_list|(
literal|"*"
argument_list|)
operator|&&
name|node
operator|!=
literal|null
operator|&&
name|node
operator|.
name|isLoaded
argument_list|()
condition|)
block|{
name|String
name|conf
init|=
name|dependencyConfigurations
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
literal|"*"
operator|.
name|equals
argument_list|(
name|conf
argument_list|)
condition|)
block|{
return|return
name|node
operator|.
name|getDescriptor
argument_list|()
operator|.
name|getPublicConfigurationsNames
argument_list|()
return|;
block|}
comment|// there are exclusions in the configuration
name|List
name|exclusions
init|=
name|Arrays
operator|.
name|asList
argument_list|(
name|conf
operator|.
name|substring
argument_list|(
literal|2
argument_list|)
operator|.
name|split
argument_list|(
literal|"\\!"
argument_list|)
argument_list|)
decl_stmt|;
name|List
name|ret
init|=
operator|new
name|ArrayList
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|node
operator|.
name|getDescriptor
argument_list|()
operator|.
name|getPublicConfigurationsNames
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|ret
operator|.
name|removeAll
argument_list|(
name|exclusions
argument_list|)
expr_stmt|;
return|return
operator|(
name|String
index|[]
operator|)
name|ret
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|ret
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
return|return
name|dependencyConfigurations
return|;
block|}
comment|/**      * returns the required configurations from the given node      * @param in      * @return      */
specifier|public
name|String
index|[]
name|getRequiredConfigurations
parameter_list|(
name|IvyNode
name|in
parameter_list|,
name|String
name|inConf
parameter_list|)
block|{
name|Collection
name|req
init|=
operator|(
name|Collection
operator|)
name|_requiredConfs
operator|.
name|get
argument_list|(
operator|new
name|NodeConf
argument_list|(
name|in
argument_list|,
name|inConf
argument_list|)
argument_list|)
decl_stmt|;
return|return
name|req
operator|==
literal|null
condition|?
operator|new
name|String
index|[
literal|0
index|]
else|:
operator|(
name|String
index|[]
operator|)
name|req
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|req
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
comment|/**      * returns all the current required configurations of the node      * @return      */
specifier|public
name|String
index|[]
name|getRequiredConfigurations
parameter_list|()
block|{
name|Collection
name|required
init|=
operator|new
name|ArrayList
argument_list|(
name|_confsToFetch
operator|.
name|size
argument_list|()
operator|+
name|_fetchedConfigurations
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
name|required
operator|.
name|addAll
argument_list|(
name|_fetchedConfigurations
argument_list|)
expr_stmt|;
name|required
operator|.
name|addAll
argument_list|(
name|_confsToFetch
argument_list|)
expr_stmt|;
return|return
operator|(
name|String
index|[]
operator|)
name|required
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|required
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
specifier|private
name|void
name|setRequiredConfs
parameter_list|(
name|IvyNode
name|parent
parameter_list|,
name|String
name|parentConf
parameter_list|,
name|Collection
name|confs
parameter_list|)
block|{
name|_requiredConfs
operator|.
name|put
argument_list|(
operator|new
name|NodeConf
argument_list|(
name|parent
argument_list|,
name|parentConf
argument_list|)
argument_list|,
operator|new
name|HashSet
argument_list|(
name|confs
argument_list|)
argument_list|)
expr_stmt|;
block|}
specifier|public
name|Configuration
name|getConfiguration
parameter_list|(
name|String
name|conf
parameter_list|)
block|{
if|if
condition|(
name|_md
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"impossible to get configuration when data has not been loaded"
argument_list|)
throw|;
block|}
name|String
name|defaultConf
init|=
name|getDefaultConf
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|conf
operator|=
name|getMainConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|Configuration
name|configuration
init|=
name|_md
operator|.
name|getConfiguration
argument_list|(
name|conf
argument_list|)
decl_stmt|;
if|if
condition|(
name|configuration
operator|==
literal|null
condition|)
block|{
name|configuration
operator|=
name|_md
operator|.
name|getConfiguration
argument_list|(
name|defaultConf
argument_list|)
expr_stmt|;
block|}
return|return
name|configuration
return|;
block|}
comment|/**      * Returns the configurations of the dependency required in a given       * root module configuration.      * @param rootModuleConf      * @return      */
specifier|public
name|String
index|[]
name|getConfigurations
parameter_list|(
name|String
name|rootModuleConf
parameter_list|)
block|{
name|Set
name|depConfs
init|=
operator|(
name|Set
operator|)
name|_rootModuleConfs
operator|.
name|get
argument_list|(
name|rootModuleConf
argument_list|)
decl_stmt|;
if|if
condition|(
name|depConfs
operator|==
literal|null
condition|)
block|{
return|return
operator|new
name|String
index|[
literal|0
index|]
return|;
block|}
return|return
operator|(
name|String
index|[]
operator|)
name|depConfs
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|depConfs
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
specifier|public
name|void
name|discardConf
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|String
name|conf
parameter_list|)
block|{
name|Set
name|depConfs
init|=
operator|(
name|Set
operator|)
name|_rootModuleConfs
operator|.
name|get
argument_list|(
name|rootModuleConf
argument_list|)
decl_stmt|;
if|if
condition|(
name|depConfs
operator|==
literal|null
condition|)
block|{
name|depConfs
operator|=
operator|new
name|HashSet
argument_list|()
expr_stmt|;
name|_rootModuleConfs
operator|.
name|put
argument_list|(
name|rootModuleConf
argument_list|,
name|depConfs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|_md
operator|!=
literal|null
condition|)
block|{
comment|// remove all given dependency configurations to the set + extended ones
name|Configuration
name|c
init|=
name|_md
operator|.
name|getConfiguration
argument_list|(
name|conf
argument_list|)
decl_stmt|;
if|if
condition|(
name|conf
operator|!=
literal|null
condition|)
block|{
name|String
index|[]
name|exts
init|=
name|c
operator|.
name|getExtends
argument_list|()
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|exts
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|discardConf
argument_list|(
name|rootModuleConf
argument_list|,
name|exts
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|// recursive remove of extended configurations
block|}
name|depConfs
operator|.
name|remove
argument_list|(
name|c
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"unknown configuration in "
operator|+
name|getId
argument_list|()
operator|+
literal|": "
operator|+
name|conf
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|depConfs
operator|.
name|remove
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|addRootModuleConfigurations
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|String
index|[]
name|dependencyConfs
parameter_list|)
block|{
name|Set
name|depConfs
init|=
operator|(
name|Set
operator|)
name|_rootModuleConfs
operator|.
name|get
argument_list|(
name|rootModuleConf
argument_list|)
decl_stmt|;
if|if
condition|(
name|depConfs
operator|==
literal|null
condition|)
block|{
name|depConfs
operator|=
operator|new
name|HashSet
argument_list|()
expr_stmt|;
name|_rootModuleConfs
operator|.
name|put
argument_list|(
name|rootModuleConf
argument_list|,
name|depConfs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|_md
operator|!=
literal|null
condition|)
block|{
comment|// add all given dependency configurations to the set + extended ones
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|dependencyConfs
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|Configuration
name|conf
init|=
name|_md
operator|.
name|getConfiguration
argument_list|(
name|dependencyConfs
index|[
name|i
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|conf
operator|!=
literal|null
condition|)
block|{
name|String
index|[]
name|exts
init|=
name|conf
operator|.
name|getExtends
argument_list|()
decl_stmt|;
name|addRootModuleConfigurations
argument_list|(
name|rootModuleConf
argument_list|,
name|exts
argument_list|)
expr_stmt|;
comment|// recursive add of extended configurations
name|depConfs
operator|.
name|add
argument_list|(
name|conf
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|warn
argument_list|(
literal|"unknown configuration in "
operator|+
name|getId
argument_list|()
operator|+
literal|": "
operator|+
name|dependencyConfs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|dependencyConfs
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|depConfs
operator|.
name|add
argument_list|(
name|dependencyConfs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**      * Returns the root module configurations in which this dependency is required       * @return      */
specifier|public
name|String
index|[]
name|getRootModuleConfigurations
parameter_list|()
block|{
return|return
operator|(
name|String
index|[]
operator|)
name|_rootModuleConfs
operator|.
name|keySet
argument_list|()
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|_rootModuleConfs
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
specifier|public
name|String
index|[]
name|getConfsToFetch
parameter_list|()
block|{
return|return
operator|(
name|String
index|[]
operator|)
name|_confsToFetch
operator|.
name|toArray
argument_list|(
operator|new
name|String
index|[
name|_confsToFetch
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
specifier|public
name|String
index|[]
name|getRealConfs
parameter_list|(
name|String
name|conf
parameter_list|)
block|{
if|if
condition|(
name|_md
operator|==
literal|null
condition|)
block|{
return|return
operator|new
name|String
index|[]
block|{
name|conf
block|}
return|;
block|}
name|String
name|defaultConf
init|=
name|getDefaultConf
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|conf
operator|=
name|getMainConf
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|_md
operator|.
name|getConfiguration
argument_list|(
name|conf
argument_list|)
operator|==
literal|null
condition|)
block|{
if|if
condition|(
literal|""
operator|.
name|equals
argument_list|(
name|defaultConf
argument_list|)
condition|)
block|{
return|return
operator|new
name|String
index|[
literal|0
index|]
return|;
block|}
name|conf
operator|=
name|defaultConf
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|.
name|startsWith
argument_list|(
literal|"*"
argument_list|)
condition|)
block|{
return|return
name|resolveSpecialConfigurations
argument_list|(
operator|new
name|String
index|[]
block|{
name|conf
block|}
argument_list|,
name|this
argument_list|)
return|;
block|}
if|else if
condition|(
name|conf
operator|.
name|indexOf
argument_list|(
literal|','
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|String
index|[]
name|confs
init|=
name|conf
operator|.
name|split
argument_list|(
literal|","
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|confs
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|confs
index|[
name|i
index|]
operator|=
name|confs
index|[
name|i
index|]
operator|.
name|trim
argument_list|()
expr_stmt|;
block|}
block|}
return|return
operator|new
name|String
index|[]
block|{
name|conf
block|}
return|;
block|}
comment|/**      * Finds and returns a path in callers from the given module id to the current node      * @param from the module id to start the path from      * @return a collection representing the path, starting with the from node, followed by      * the list of nodes being one path to the current node, excluded      */
specifier|private
name|Collection
name|findPath
parameter_list|(
name|ModuleId
name|from
parameter_list|)
block|{
return|return
name|findPath
argument_list|(
name|from
argument_list|,
name|this
argument_list|,
operator|new
name|LinkedList
argument_list|()
argument_list|)
return|;
block|}
specifier|private
name|Collection
name|findPath
parameter_list|(
name|ModuleId
name|from
parameter_list|,
name|IvyNode
name|node
parameter_list|,
name|List
name|path
parameter_list|)
block|{
name|IvyNode
name|parent
init|=
operator|(
name|IvyNode
operator|)
name|node
operator|.
name|getDirectCallerFor
argument_list|(
name|from
argument_list|)
decl_stmt|;
if|if
condition|(
name|parent
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"no path from "
operator|+
name|from
operator|+
literal|" to "
operator|+
name|getId
argument_list|()
operator|+
literal|" found"
argument_list|)
throw|;
block|}
if|if
condition|(
name|path
operator|.
name|contains
argument_list|(
name|parent
argument_list|)
condition|)
block|{
name|path
operator|.
name|add
argument_list|(
literal|0
argument_list|,
name|parent
argument_list|)
expr_stmt|;
name|Message
operator|.
name|verbose
argument_list|(
literal|"circular dependency found while looking for the path for another one: was looking for "
operator|+
name|from
operator|+
literal|" as a caller of "
operator|+
name|path
operator|.
name|get
argument_list|(
name|path
operator|.
name|size
argument_list|()
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|path
return|;
block|}
name|path
operator|.
name|add
argument_list|(
literal|0
argument_list|,
name|parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|parent
operator|.
name|getId
argument_list|()
operator|.
name|getModuleId
argument_list|()
operator|.
name|equals
argument_list|(
name|from
argument_list|)
condition|)
block|{
return|return
name|path
return|;
block|}
return|return
name|findPath
argument_list|(
name|from
argument_list|,
name|parent
argument_list|,
name|path
argument_list|)
return|;
block|}
specifier|private
name|void
name|updateDataFrom
parameter_list|(
name|IvyNode
name|node
parameter_list|,
name|String
name|rootModuleConf
parameter_list|)
block|{
comment|// update callers
name|_callers
operator|.
name|updateFrom
argument_list|(
name|node
operator|.
name|_callers
argument_list|,
name|rootModuleConf
argument_list|)
expr_stmt|;
comment|// update requiredConfs
name|updateMapOfSet
argument_list|(
name|node
operator|.
name|_requiredConfs
argument_list|,
name|_requiredConfs
argument_list|)
expr_stmt|;
comment|// update rootModuleConfs
name|updateMapOfSetForKey
argument_list|(
name|node
operator|.
name|_rootModuleConfs
argument_list|,
name|_rootModuleConfs
argument_list|,
name|rootModuleConf
argument_list|)
expr_stmt|;
comment|// update dependencyArtifactsIncludes
name|updateMapOfSetForKey
argument_list|(
name|node
operator|.
name|_dependencyArtifacts
argument_list|,
name|_dependencyArtifacts
argument_list|,
name|rootModuleConf
argument_list|)
expr_stmt|;
comment|// update confsToFetch
name|updateConfsToFetch
argument_list|(
name|node
operator|.
name|_fetchedConfigurations
argument_list|)
expr_stmt|;
name|updateConfsToFetch
argument_list|(
name|node
operator|.
name|_confsToFetch
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|updateMapOfSet
parameter_list|(
name|Map
name|from
parameter_list|,
name|Map
name|to
parameter_list|)
block|{
for|for
control|(
name|Iterator
name|iter
init|=
name|from
operator|.
name|keySet
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|Object
name|key
init|=
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|updateMapOfSetForKey
argument_list|(
name|from
argument_list|,
name|to
argument_list|,
name|key
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|updateMapOfSetForKey
parameter_list|(
name|Map
name|from
parameter_list|,
name|Map
name|to
parameter_list|,
name|Object
name|key
parameter_list|)
block|{
name|Set
name|set
init|=
operator|(
name|Set
operator|)
name|from
operator|.
name|get
argument_list|(
name|key
argument_list|)
decl_stmt|;
if|if
condition|(
name|set
operator|!=
literal|null
condition|)
block|{
name|Set
name|toupdate
init|=
operator|(
name|Set
operator|)
name|to
operator|.
name|get
argument_list|(
name|key
argument_list|)
decl_stmt|;
if|if
condition|(
name|toupdate
operator|!=
literal|null
condition|)
block|{
name|toupdate
operator|.
name|addAll
argument_list|(
name|set
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|to
operator|.
name|put
argument_list|(
name|key
argument_list|,
operator|new
name|HashSet
argument_list|(
name|set
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**      * Returns all the artifacts of this dependency required in all the      * root module configurations      * @return      */
specifier|public
name|Artifact
index|[]
name|getAllArtifacts
parameter_list|()
block|{
name|Set
name|ret
init|=
operator|new
name|HashSet
argument_list|()
decl_stmt|;
for|for
control|(
name|Iterator
name|it
init|=
name|_rootModuleConfs
operator|.
name|keySet
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|it
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|String
name|rootModuleConf
init|=
operator|(
name|String
operator|)
name|it
operator|.
name|next
argument_list|()
decl_stmt|;
name|ret
operator|.
name|addAll
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|getArtifacts
argument_list|(
name|rootModuleConf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|Artifact
index|[]
operator|)
name|ret
operator|.
name|toArray
argument_list|(
operator|new
name|Artifact
index|[
name|ret
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
comment|/**      * Returns all the artifacts of this dependency required in the      * root module configurations in which the node is not evicted      * @param artifactFilter       * @return      */
specifier|public
name|Artifact
index|[]
name|getSelectedArtifacts
parameter_list|(
name|Filter
name|artifactFilter
parameter_list|)
block|{
name|Collection
name|ret
init|=
operator|new
name|HashSet
argument_list|()
decl_stmt|;
for|for
control|(
name|Iterator
name|it
init|=
name|_rootModuleConfs
operator|.
name|keySet
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|it
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|String
name|rootModuleConf
init|=
operator|(
name|String
operator|)
name|it
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|isEvicted
argument_list|(
name|rootModuleConf
argument_list|)
condition|)
block|{
name|ret
operator|.
name|addAll
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|getArtifacts
argument_list|(
name|rootModuleConf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ret
operator|=
name|FilterHelper
operator|.
name|filter
argument_list|(
name|ret
argument_list|,
name|artifactFilter
argument_list|)
expr_stmt|;
return|return
operator|(
name|Artifact
index|[]
operator|)
name|ret
operator|.
name|toArray
argument_list|(
operator|new
name|Artifact
index|[
name|ret
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
comment|/**      * Returns the artifacts of this dependency required in the      * configurations themselves required in the given root module configuration      * @param rootModuleConf      * @return      */
specifier|public
name|Artifact
index|[]
name|getArtifacts
parameter_list|(
name|String
name|rootModuleConf
parameter_list|)
block|{
comment|// first we look for the dependency configurations required
comment|// in the given root module configuration
name|Set
name|confs
init|=
operator|(
name|Set
operator|)
name|_rootModuleConfs
operator|.
name|get
argument_list|(
name|rootModuleConf
argument_list|)
decl_stmt|;
if|if
condition|(
name|confs
operator|==
literal|null
condition|)
block|{
comment|// no configuration required => no artifact required
return|return
operator|new
name|Artifact
index|[
literal|0
index|]
return|;
block|}
name|Set
name|artifacts
init|=
operator|new
name|HashSet
argument_list|()
decl_stmt|;
comment|// the set we fill before returning
comment|// we check if we have dependencyArtifacts includes description for this rootModuleConf
name|Set
name|dependencyArtifacts
init|=
operator|(
name|Set
operator|)
name|_dependencyArtifacts
operator|.
name|get
argument_list|(
name|rootModuleConf
argument_list|)
decl_stmt|;
if|if
condition|(
name|_md
operator|.
name|isDefault
argument_list|()
operator|&&
name|dependencyArtifacts
operator|!=
literal|null
operator|&&
operator|!
name|dependencyArtifacts
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// the descriptor is a default one: it has been generated from nothing
comment|// moreover, we have dependency artifacts description
comment|// these descritions are thus used as if they were declared in the module
comment|// descriptor. If one is not really present, the error will be raised
comment|// at download time
for|for
control|(
name|Iterator
name|it
init|=
name|dependencyArtifacts
operator|.
name|iterator
argument_list|()
init|;
name|it
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|DependencyArtifactDescriptor
name|dad
init|=
operator|(
name|DependencyArtifactDescriptor
operator|)
name|it
operator|.
name|next
argument_list|()
decl_stmt|;
name|artifacts
operator|.
name|add
argument_list|(
operator|new
name|MDArtifact
argument_list|(
name|_md
argument_list|,
name|dad
operator|.
name|getName
argument_list|()
argument_list|,
name|dad
operator|.
name|getType
argument_list|()
argument_list|,
name|dad
operator|.
name|getExt
argument_list|()
argument_list|,
name|dad
operator|.
name|getUrl
argument_list|()
argument_list|,
name|dad
operator|.
name|getExtraAttributes
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|Set
name|includes
init|=
operator|(
name|Set
operator|)
name|_dependencyIncludes
operator|.
name|get
argument_list|(
name|rootModuleConf
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|dependencyArtifacts
operator|==
literal|null
operator|||
name|dependencyArtifacts
operator|.
name|isEmpty
argument_list|()
operator|)
operator|&&
operator|(
name|includes
operator|==
literal|null
operator|||
name|includes
operator|.
name|isEmpty
argument_list|()
operator|)
condition|)
block|{
comment|// no artifacts / includes: we get all artifacts as defined by the descriptor
for|for
control|(
name|Iterator
name|iter
init|=
name|confs
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|String
name|conf
init|=
operator|(
name|String
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|artifacts
operator|.
name|addAll
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|_md
operator|.
name|getArtifacts
argument_list|(
name|conf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// we have to get only artifacts listed as "includes"
comment|// first we get all artifacts as defined by the module descriptor
comment|// and classify them by artifact id
name|Map
name|allArtifacts
init|=
operator|new
name|HashMap
argument_list|()
decl_stmt|;
for|for
control|(
name|Iterator
name|iter
init|=
name|confs
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|String
name|conf
init|=
operator|(
name|String
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|Artifact
index|[]
name|arts
init|=
name|_md
operator|.
name|getArtifacts
argument_list|(
name|conf
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|arts
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|allArtifacts
operator|.
name|put
argument_list|(
name|arts
index|[
name|i
index|]
operator|.
name|getId
argument_list|()
operator|.
name|getArtifactId
argument_list|()
argument_list|,
name|arts
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
comment|// now we add caller defined ones
for|for
control|(
name|Iterator
name|it
init|=
name|dependencyArtifacts
operator|.
name|iterator
argument_list|()
init|;
name|it
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|DependencyArtifactDescriptor
name|dad
init|=
operator|(
name|DependencyArtifactDescriptor
operator|)
name|it
operator|.
name|next
argument_list|()
decl_stmt|;
name|artifacts
operator|.
name|add
argument_list|(
operator|new
name|MDArtifact
argument_list|(
name|_md
argument_list|,
name|dad
operator|.
name|getName
argument_list|()
argument_list|,
name|dad
operator|.
name|getType
argument_list|()
argument_list|,
name|dad
operator|.
name|getExt
argument_list|()
argument_list|,
name|dad
operator|.
name|getUrl
argument_list|()
argument_list|,
name|dad
operator|.
name|getExtraAttributes
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|// and now we filter according to include rules
for|for
control|(
name|Iterator
name|it
init|=
name|includes
operator|.
name|iterator
argument_list|()
init|;
name|it
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|IncludeRule
name|dad
init|=
operator|(
name|IncludeRule
operator|)
name|it
operator|.
name|next
argument_list|()
decl_stmt|;
name|Collection
name|arts
init|=
name|findArtifactsMatching
argument_list|(
name|dad
argument_list|,
name|allArtifacts
argument_list|)
decl_stmt|;
if|if
condition|(
name|arts
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|Message
operator|.
name|error
argument_list|(
literal|"a required artifact is not listed by module descriptor: "
operator|+
name|dad
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
comment|// we remove it from required list to prevent message to be displayed more than once
name|it
operator|.
name|remove
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|Message
operator|.
name|debug
argument_list|(
name|this
operator|+
literal|" in "
operator|+
name|rootModuleConf
operator|+
literal|": including "
operator|+
name|arts
argument_list|)
expr_stmt|;
name|artifacts
operator|.
name|addAll
argument_list|(
name|arts
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|// now excludes artifacts that aren't accepted by any caller
for|for
control|(
name|Iterator
name|iter
init|=
name|artifacts
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|Artifact
name|artifact
init|=
operator|(
name|Artifact
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|boolean
name|excluded
init|=
name|_callers
operator|.
name|doesCallersExclude
argument_list|(
name|rootModuleConf
argument_list|,
name|artifact
argument_list|)
decl_stmt|;
if|if
condition|(
name|excluded
condition|)
block|{
name|Message
operator|.
name|debug
argument_list|(
name|this
operator|+
literal|" in "
operator|+
name|rootModuleConf
operator|+
literal|": excluding "
operator|+
name|artifact
argument_list|)
expr_stmt|;
name|iter
operator|.
name|remove
argument_list|()
expr_stmt|;
block|}
block|}
return|return
operator|(
name|Artifact
index|[]
operator|)
name|artifacts
operator|.
name|toArray
argument_list|(
operator|new
name|Artifact
index|[
name|artifacts
operator|.
name|size
argument_list|()
index|]
argument_list|)
return|;
block|}
specifier|private
specifier|static
name|Collection
name|findArtifactsMatching
parameter_list|(
name|IncludeRule
name|rule
parameter_list|,
name|Map
name|allArtifacts
parameter_list|)
block|{
name|Collection
name|ret
init|=
operator|new
name|ArrayList
argument_list|()
decl_stmt|;
for|for
control|(
name|Iterator
name|iter
init|=
name|allArtifacts
operator|.
name|keySet
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|ArtifactId
name|aid
init|=
operator|(
name|ArtifactId
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
name|MatcherHelper
operator|.
name|matches
argument_list|(
name|rule
operator|.
name|getMatcher
argument_list|()
argument_list|,
name|rule
operator|.
name|getId
argument_list|()
argument_list|,
name|aid
argument_list|)
condition|)
block|{
name|ret
operator|.
name|add
argument_list|(
name|allArtifacts
operator|.
name|get
argument_list|(
name|aid
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
specifier|private
name|void
name|addDependencyArtifacts
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|DependencyArtifactDescriptor
index|[]
name|dependencyArtifacts
parameter_list|)
block|{
name|addObjectsForConf
argument_list|(
name|rootModuleConf
argument_list|,
name|Arrays
operator|.
name|asList
argument_list|(
name|dependencyArtifacts
argument_list|)
argument_list|,
name|_dependencyArtifacts
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|addDependencyIncludes
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|IncludeRule
index|[]
name|rules
parameter_list|)
block|{
name|addObjectsForConf
argument_list|(
name|rootModuleConf
argument_list|,
name|Arrays
operator|.
name|asList
argument_list|(
name|rules
argument_list|)
argument_list|,
name|_dependencyIncludes
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|addObjectsForConf
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|Collection
name|objectsToAdd
parameter_list|,
name|Map
name|map
parameter_list|)
block|{
name|Set
name|set
init|=
operator|(
name|Set
operator|)
name|map
operator|.
name|get
argument_list|(
name|rootModuleConf
argument_list|)
decl_stmt|;
if|if
condition|(
name|set
operator|==
literal|null
condition|)
block|{
name|set
operator|=
operator|new
name|HashSet
argument_list|()
expr_stmt|;
name|map
operator|.
name|put
argument_list|(
name|rootModuleConf
argument_list|,
name|set
argument_list|)
expr_stmt|;
block|}
name|set
operator|.
name|addAll
argument_list|(
name|objectsToAdd
argument_list|)
expr_stmt|;
block|}
specifier|public
name|boolean
name|hasProblem
parameter_list|()
block|{
return|return
name|_problem
operator|!=
literal|null
return|;
block|}
specifier|public
name|Exception
name|getProblem
parameter_list|()
block|{
return|return
name|_problem
return|;
block|}
specifier|public
name|String
name|getProblemMessage
parameter_list|()
block|{
name|Exception
name|e
init|=
name|_problem
decl_stmt|;
if|if
condition|(
name|e
operator|==
literal|null
condition|)
block|{
return|return
literal|""
return|;
block|}
name|String
name|errMsg
init|=
name|e
operator|instanceof
name|RuntimeException
condition|?
name|e
operator|.
name|getMessage
argument_list|()
else|:
name|e
operator|.
name|toString
argument_list|()
decl_stmt|;
if|if
condition|(
name|errMsg
operator|==
literal|null
operator|||
name|errMsg
operator|.
name|length
argument_list|()
operator|==
literal|0
operator|||
literal|"null"
operator|.
name|equals
argument_list|(
name|errMsg
argument_list|)
condition|)
block|{
name|errMsg
operator|=
name|e
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
operator|+
literal|" at "
operator|+
name|e
operator|.
name|getStackTrace
argument_list|()
index|[
literal|0
index|]
operator|.
name|toString
argument_list|()
expr_stmt|;
block|}
return|return
name|errMsg
return|;
block|}
specifier|public
name|boolean
name|isDownloaded
parameter_list|()
block|{
return|return
name|_downloaded
return|;
block|}
specifier|public
name|boolean
name|isSearched
parameter_list|()
block|{
return|return
name|_searched
return|;
block|}
specifier|public
name|boolean
name|isLoaded
parameter_list|()
block|{
return|return
name|_md
operator|!=
literal|null
return|;
block|}
specifier|public
name|boolean
name|isFetched
parameter_list|(
name|String
name|conf
parameter_list|)
block|{
return|return
name|_fetchedConfigurations
operator|.
name|contains
argument_list|(
name|conf
argument_list|)
return|;
block|}
specifier|public
name|IvyNode
name|findNode
parameter_list|(
name|ModuleRevisionId
name|mrid
parameter_list|)
block|{
return|return
name|_data
operator|.
name|getNode
argument_list|(
name|mrid
argument_list|)
return|;
block|}
name|boolean
name|isRoot
parameter_list|()
block|{
return|return
name|_root
operator|==
name|this
return|;
block|}
specifier|public
name|IvyNode
name|getRoot
parameter_list|()
block|{
return|return
name|_root
return|;
block|}
specifier|public
name|ConflictManager
name|getConflictManager
parameter_list|(
name|ModuleId
name|mid
parameter_list|)
block|{
if|if
condition|(
name|_md
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalStateException
argument_list|(
literal|"impossible to get conflict manager when data has not been loaded"
argument_list|)
throw|;
block|}
name|ConflictManager
name|cm
init|=
name|_md
operator|.
name|getConflictManager
argument_list|(
name|mid
argument_list|)
decl_stmt|;
return|return
name|cm
operator|==
literal|null
condition|?
name|_settings
operator|.
name|getConflictManager
argument_list|(
name|mid
argument_list|)
else|:
name|cm
return|;
block|}
specifier|public
name|IvyNode
name|getRealNode
parameter_list|()
block|{
name|IvyNode
name|real
init|=
name|_data
operator|.
name|getNode
argument_list|(
name|getId
argument_list|()
argument_list|)
decl_stmt|;
return|return
name|real
operator|!=
literal|null
condition|?
name|real
else|:
name|this
return|;
block|}
specifier|public
name|ModuleRevisionId
name|getId
parameter_list|()
block|{
return|return
name|_id
return|;
block|}
specifier|public
name|ModuleId
name|getModuleId
parameter_list|()
block|{
return|return
name|_id
operator|.
name|getModuleId
argument_list|()
return|;
block|}
specifier|public
name|ModuleDescriptor
name|getDescriptor
parameter_list|()
block|{
return|return
name|_md
return|;
block|}
specifier|public
name|ResolveData
name|getData
parameter_list|()
block|{
return|return
name|_data
return|;
block|}
specifier|public
name|ResolvedModuleRevision
name|getModuleRevision
parameter_list|()
block|{
return|return
name|_module
return|;
block|}
specifier|public
name|long
name|getPublication
parameter_list|()
block|{
if|if
condition|(
name|_module
operator|!=
literal|null
condition|)
block|{
return|return
name|_module
operator|.
name|getPublicationDate
argument_list|()
operator|.
name|getTime
argument_list|()
return|;
block|}
return|return
literal|0
return|;
block|}
comment|/**      * Returns the last modified timestamp of the module represented by this Node,      * or 0 if the last modified timestamp is currently unkwown (module not loaded)      * @return the last modified timestamp of the module represented by this Node      */
specifier|public
name|long
name|getLastModified
parameter_list|()
block|{
if|if
condition|(
name|_md
operator|!=
literal|null
condition|)
block|{
return|return
name|_md
operator|.
name|getLastModified
argument_list|()
return|;
block|}
return|return
literal|0
return|;
block|}
specifier|public
name|ModuleRevisionId
name|getResolvedId
parameter_list|()
block|{
if|if
condition|(
name|_md
operator|!=
literal|null
operator|&&
name|_md
operator|.
name|getResolvedModuleRevisionId
argument_list|()
operator|.
name|getRevision
argument_list|()
operator|!=
literal|null
condition|)
block|{
return|return
name|_md
operator|.
name|getResolvedModuleRevisionId
argument_list|()
return|;
block|}
if|else if
condition|(
name|_module
operator|!=
literal|null
condition|)
block|{
return|return
name|_module
operator|.
name|getId
argument_list|()
return|;
block|}
else|else
block|{
return|return
name|getId
argument_list|()
return|;
block|}
block|}
comment|/** 	 * Clean data related to one root module configuration only 	 */
specifier|public
name|void
name|clean
parameter_list|()
block|{
name|_confsToFetch
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
comment|///////////////////////////////////////////////////////////////////////////////
comment|//          CALLERS MANAGEMENT
comment|///////////////////////////////////////////////////////////////////////////////
name|boolean
name|canExclude
parameter_list|(
name|String
name|rootModuleConf
parameter_list|)
block|{
name|Caller
index|[]
name|callers
init|=
name|getCallers
argument_list|(
name|rootModuleConf
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|callers
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|callers
index|[
name|i
index|]
operator|.
name|canExclude
argument_list|()
condition|)
block|{
return|return
literal|true
return|;
block|}
block|}
return|return
literal|false
return|;
block|}
specifier|private
name|IvyNode
name|getDirectCallerFor
parameter_list|(
name|ModuleId
name|from
parameter_list|)
block|{
return|return
name|_callers
operator|.
name|getDirectCallerFor
argument_list|(
name|from
argument_list|)
return|;
block|}
specifier|public
name|Caller
index|[]
name|getCallers
parameter_list|(
name|String
name|rootModuleConf
parameter_list|)
block|{
return|return
name|_callers
operator|.
name|getCallers
argument_list|(
name|rootModuleConf
argument_list|)
return|;
block|}
specifier|public
name|Collection
name|getAllCallersModuleIds
parameter_list|()
block|{
return|return
name|_callers
operator|.
name|getAllCallersModuleIds
argument_list|()
return|;
block|}
specifier|public
name|Caller
index|[]
name|getAllCallers
parameter_list|()
block|{
return|return
name|_callers
operator|.
name|getAllCallers
argument_list|()
return|;
block|}
specifier|public
name|void
name|addCaller
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|IvyNode
name|callerNode
parameter_list|,
name|String
name|callerConf
parameter_list|,
name|String
index|[]
name|dependencyConfs
parameter_list|,
name|DependencyDescriptor
name|dd
parameter_list|)
block|{
name|_callers
operator|.
name|addCaller
argument_list|(
name|rootModuleConf
argument_list|,
name|callerNode
argument_list|,
name|callerConf
argument_list|,
name|dependencyConfs
argument_list|,
name|dd
argument_list|)
expr_stmt|;
name|boolean
name|isCircular
init|=
name|_callers
operator|.
name|getAllCallersModuleIds
argument_list|()
operator|.
name|contains
argument_list|(
name|getId
argument_list|()
operator|.
name|getModuleId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|isCircular
condition|)
block|{
name|IvyContext
operator|.
name|getContext
argument_list|()
operator|.
name|getCircularDependencyStrategy
argument_list|()
operator|.
name|handleCircularDependency
argument_list|(
name|toMrids
argument_list|(
name|findPath
argument_list|(
name|getId
argument_list|()
operator|.
name|getModuleId
argument_list|()
argument_list|)
argument_list|,
name|this
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|boolean
name|doesCallersExclude
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|Artifact
name|artifact
parameter_list|,
name|Stack
name|callersStack
parameter_list|)
block|{
return|return
name|_callers
operator|.
name|doesCallersExclude
argument_list|(
name|rootModuleConf
argument_list|,
name|artifact
argument_list|,
name|callersStack
argument_list|)
return|;
block|}
specifier|private
name|ModuleRevisionId
index|[]
name|toMrids
parameter_list|(
name|Collection
name|path
parameter_list|,
name|IvyNode
name|depNode
parameter_list|)
block|{
name|ModuleRevisionId
index|[]
name|ret
init|=
operator|new
name|ModuleRevisionId
index|[
name|path
operator|.
name|size
argument_list|()
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
for|for
control|(
name|Iterator
name|iter
init|=
name|path
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|IvyNode
name|node
init|=
operator|(
name|IvyNode
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|ret
index|[
name|i
index|]
operator|=
name|node
operator|.
name|getId
argument_list|()
expr_stmt|;
block|}
name|ret
index|[
name|ret
operator|.
name|length
operator|-
literal|1
index|]
operator|=
name|depNode
operator|.
name|getId
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|///////////////////////////////////////////////////////////////////////////////
comment|//          EVICTION MANAGEMENT
comment|///////////////////////////////////////////////////////////////////////////////
specifier|public
name|Collection
name|getResolvedNodes
parameter_list|(
name|ModuleId
name|moduleId
parameter_list|,
name|String
name|rootModuleConf
parameter_list|)
block|{
return|return
name|_eviction
operator|.
name|getResolvedNodes
argument_list|(
name|moduleId
argument_list|,
name|rootModuleConf
argument_list|)
return|;
block|}
specifier|public
name|Collection
name|getResolvedRevisions
parameter_list|(
name|ModuleId
name|moduleId
parameter_list|,
name|String
name|rootModuleConf
parameter_list|)
block|{
return|return
name|_eviction
operator|.
name|getResolvedRevisions
argument_list|(
name|moduleId
argument_list|,
name|rootModuleConf
argument_list|)
return|;
block|}
specifier|public
name|void
name|markEvicted
parameter_list|(
name|EvictionData
name|evictionData
parameter_list|)
block|{
name|_eviction
operator|.
name|markEvicted
argument_list|(
name|evictionData
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|_rootModuleConfs
operator|.
name|keySet
argument_list|()
operator|.
name|contains
argument_list|(
name|evictionData
operator|.
name|getRootModuleConf
argument_list|()
argument_list|)
condition|)
block|{
name|_rootModuleConfs
operator|.
name|put
argument_list|(
name|evictionData
operator|.
name|getRootModuleConf
argument_list|()
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
comment|// bug 105: update selected data with evicted one
if|if
condition|(
name|evictionData
operator|.
name|getSelected
argument_list|()
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|Iterator
name|iter
init|=
name|evictionData
operator|.
name|getSelected
argument_list|()
operator|.
name|iterator
argument_list|()
init|;
name|iter
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|IvyNode
name|selected
init|=
operator|(
name|IvyNode
operator|)
name|iter
operator|.
name|next
argument_list|()
decl_stmt|;
name|selected
operator|.
name|updateDataFrom
argument_list|(
name|this
argument_list|,
name|evictionData
operator|.
name|getRootModuleConf
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|public
name|Collection
name|getAllEvictingConflictManagers
parameter_list|()
block|{
return|return
name|_eviction
operator|.
name|getAllEvictingConflictManagers
argument_list|()
return|;
block|}
specifier|public
name|Collection
name|getAllEvictingNodes
parameter_list|()
block|{
return|return
name|_eviction
operator|.
name|getAllEvictingNodes
argument_list|()
return|;
block|}
specifier|public
name|String
index|[]
name|getEvictedConfs
parameter_list|()
block|{
return|return
name|_eviction
operator|.
name|getEvictedConfs
argument_list|()
return|;
block|}
specifier|public
name|EvictionData
name|getEvictedData
parameter_list|(
name|String
name|rootModuleConf
parameter_list|)
block|{
return|return
name|_eviction
operator|.
name|getEvictedData
argument_list|(
name|rootModuleConf
argument_list|)
return|;
block|}
specifier|public
name|Collection
name|getEvictedNodes
parameter_list|(
name|ModuleId
name|mid
parameter_list|,
name|String
name|rootModuleConf
parameter_list|)
block|{
return|return
name|_eviction
operator|.
name|getEvictedNodes
argument_list|(
name|mid
argument_list|,
name|rootModuleConf
argument_list|)
return|;
block|}
specifier|public
name|Collection
name|getEvictedRevisions
parameter_list|(
name|ModuleId
name|mid
parameter_list|,
name|String
name|rootModuleConf
parameter_list|)
block|{
return|return
name|_eviction
operator|.
name|getEvictedRevisions
argument_list|(
name|mid
argument_list|,
name|rootModuleConf
argument_list|)
return|;
block|}
specifier|public
name|EvictionData
name|getEvictionDataInRoot
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|IvyNode
name|ancestor
parameter_list|)
block|{
return|return
name|_eviction
operator|.
name|getEvictionDataInRoot
argument_list|(
name|rootModuleConf
argument_list|,
name|ancestor
argument_list|)
return|;
block|}
specifier|public
name|boolean
name|isCompletelyEvicted
parameter_list|()
block|{
return|return
name|_eviction
operator|.
name|isCompletelyEvicted
argument_list|()
return|;
block|}
specifier|public
name|boolean
name|isEvicted
parameter_list|(
name|String
name|rootModuleConf
parameter_list|)
block|{
return|return
name|_eviction
operator|.
name|isEvicted
argument_list|(
name|rootModuleConf
argument_list|)
return|;
block|}
specifier|public
name|void
name|markEvicted
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|IvyNode
name|node
parameter_list|,
name|ConflictManager
name|conflictManager
parameter_list|,
name|Collection
name|resolved
parameter_list|)
block|{
name|_eviction
operator|.
name|markEvicted
argument_list|(
name|rootModuleConf
argument_list|,
name|node
argument_list|,
name|conflictManager
argument_list|,
name|resolved
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|setEvictedNodes
parameter_list|(
name|ModuleId
name|moduleId
parameter_list|,
name|String
name|rootModuleConf
parameter_list|,
name|Collection
name|evicted
parameter_list|)
block|{
name|_eviction
operator|.
name|setEvictedNodes
argument_list|(
name|moduleId
argument_list|,
name|rootModuleConf
argument_list|,
name|evicted
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|setResolvedNodes
parameter_list|(
name|ModuleId
name|moduleId
parameter_list|,
name|String
name|rootModuleConf
parameter_list|,
name|Collection
name|resolved
parameter_list|)
block|{
name|_eviction
operator|.
name|setResolvedNodes
argument_list|(
name|moduleId
argument_list|,
name|rootModuleConf
argument_list|,
name|resolved
argument_list|)
expr_stmt|;
block|}
specifier|public
name|String
name|toString
parameter_list|()
block|{
return|return
name|getResolvedId
argument_list|()
operator|.
name|toString
argument_list|()
return|;
block|}
specifier|public
name|boolean
name|equals
parameter_list|(
name|Object
name|obj
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|obj
operator|instanceof
name|IvyNode
operator|)
condition|)
block|{
return|return
literal|false
return|;
block|}
name|IvyNode
name|node
init|=
operator|(
name|IvyNode
operator|)
name|obj
decl_stmt|;
return|return
name|node
operator|.
name|getId
argument_list|()
operator|.
name|equals
argument_list|(
name|getId
argument_list|()
argument_list|)
return|;
block|}
specifier|public
name|int
name|compareTo
parameter_list|(
name|Object
name|obj
parameter_list|)
block|{
name|IvyNode
name|that
init|=
operator|(
name|IvyNode
operator|)
name|obj
decl_stmt|;
return|return
name|this
operator|.
name|getModuleId
argument_list|()
operator|.
name|compareTo
argument_list|(
name|that
operator|.
name|getModuleId
argument_list|()
argument_list|)
return|;
block|}
specifier|public
name|int
name|hashCode
parameter_list|()
block|{
return|return
name|getId
argument_list|()
operator|.
name|hashCode
argument_list|()
return|;
block|}
comment|/**      * Returns a collection of Nodes in conflict for which conflict has been detected      * but conflict resolution hasn't been done yet      * @param rootModuleConf      * @param mid the module id for which pending conflicts should be found      * @return a Collection of IvyNode in pending conflict      */
specifier|public
name|Collection
name|getPendingConflicts
parameter_list|(
name|String
name|rootModuleConf
parameter_list|,
name|ModuleId
name|mid
parameter_list|)
block|{
return|return
name|_eviction
operator|.
name|getPendingConflicts
argument_list|(
name|rootModuleConf
argument_list|,
name|mid
argument_list|)
return|;
block|}
specifier|public
name|void
name|setPendingConflicts
parameter_list|(
name|ModuleId
name|moduleId
parameter_list|,
name|String
name|rootModuleConf
parameter_list|,
name|Collection
name|conflicts
parameter_list|)
block|{
name|_eviction
operator|.
name|setPendingConflicts
argument_list|(
name|moduleId
argument_list|,
name|rootModuleConf
argument_list|,
name|conflicts
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

